<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAYROLL SYSTEM</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/6SF5KQG.png">
<link rel="stylesheet" type="text/css" href="payroll-print.css">
<!-- CryptoJS for AES decryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
 


</style>
</head>
<body>
          <!-- PAYROLL MODAL -->
          <div class="payroll-modal-overlay" id="payrollModalOverlay">
            <div class="payroll-modal" id="payrollModalBox">
              <!-- Header -->
              <div class="payroll-modal-header">Payroll Settings</div>

              <!-- Body: Dynamic Table -->
              <div class="payroll-modal-body">
                <table>
                  <thead>
                    <tr>
                      <th rowspan="2">Area</th>
                      <th colspan="2">Rates</th>
                      <th colspan="3">Cut-Off</th>
                    </tr>
                    <tr>
                      <th>Fixed Rate</th>
                      <th>Daily Rate</th>
                      <th>Monthly</th>
                      <th>Semi Monthly</th>
                      <th>Weekly</th>
                    </tr>
                  </thead>
                  <tbody id="payrollTableBody">
                    <!-- Dynamic rows inserted here via JS -->
                  </tbody>
                </table>
              </div>

              <!-- Footer: Buttons -->
              <div class="payroll-modal-footer">
                <button class="payroll-btn payroll-btn-close" onclick="closePayrollModal()">Cancel</button>
                <button class="payroll-btn payroll-btn-primary" onclick="savePayrollSettingsFrontend()">Save</button>
              </div>
            </div>
          </div>


  
<header class="ios-header">
  <div class="ios-logo">
    <img src="https://i.imgur.com/6SF5KQG.png" alt="Logo">
    <span class="app-name">Payroll System</span>
  </div>

  <div class="ios-right">
    <div class="ios-tabs">
      <!-- Only Attendance Logs is a main tab -->
      <div class="ios-tab ios-tab--simple tab" data-tab="logs" data-target="logs">Attendance Logs</div>

      <!-- Adjustments dropdown -->
      <div class="ios-tab ios-tab--dropdown" data-dropdown="adjustmentsMenu">
        Adjustments <span class="chev">‚ñæ</span>
        <div class="ios-dropdown" id="adjustmentsMenu">
          <a href="#" data-target="tab2">Addition & Deduction</a>
          
        </div>
      </div>

      <!-- Reports dropdown -->
      <div class="ios-tab ios-tab--dropdown" data-dropdown="reportsMenu">
        Reports <span class="chev">‚ñæ</span>
        <div class="ios-dropdown" id="reportsMenu">
          <a href="#" data-target="tab3">Payroll Report</a>
          <a href="#" data-target="tab4">Time In / Time Out</a>
          <a href="#" data-target="tab5">13th Month Pay</a>
        </div>
      </div>
  </div>
    </div>

    <!-- Settings -->
    <div class="settings-dropdown">
      <button class="settings-btn">‚öôÔ∏è</button>
      <div class="settings-menu">
        <h3 class="title">Settings</h3>
        <button onclick="openPayrollModal()">Payroll Settings</button>
        <button id="themeToggle">Dark Mode</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>


</header>


<div class="tab-content active" id="logs">
  <div class="filters">
    <select id="areaFilter"><option value="">All Areas</option></select>
    <input type="month" id="monthFilter">
    <input type="text" id="searchName" placeholder="Search by Name...">
    <button onclick="loadLogs()">Search</button>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>NAME</th><th>AREA</th><th>TIME IN</th><th>TIME OUT</th><th>DATE</th></tr>
      </thead>
      <tbody id="logsTable"><tr><td colspan='5'>Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div class="tab-content" id="tab2">
  <div class="filters">
    <span style="font-size: 24px; cursor: pointer;">üîç</span>
    <input type="text" id="rateSearch" placeholder="Search employee...">
    <button id="scanQRBtn" class="btn btn-success">üì∑ Scan QR to Add Employee</button>
  </div>
  <div class="table-container">
    <table id="myTable">
      <thead>
        <tr>
          <th>EMPLOYEE ID</th><th>NAME</th><th>AREA</th><th>DESIGNATION</th><th>MONTHLY SALARY</th><th>TIME EXEMPTED</th> <th>ACTION</th>
        </tr>
      </thead>
      <tbody id="ratesTable"><tr><td colspan='7'>Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="qrModal" class="modal">
  <div class="modal-content">
    <span id="closeQrModal" class="close-btn">&times;</span>
    <h2 class="modal-title">Scan QR Code</h2>
      <div class="qr-section">
        <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"type="text" id="qrInput" placeholder="Scan QR code...."autofocus>
      </div>
      
    <div class="modal-body">
      <div class="info-fields">
        <input  type="text" id="empID" placeholder="Employee ID" disabled>
        <input  type="text" id="empName" placeholder="Employee Name" disabled>
        <input  type="text" id="empArea" placeholder="Area" disabled>
      </div>

      <div class="edit-section">
        
        <label class="switch">
          <input type="checkbox" id="toggleEditBtnAdd">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Edit</span>


        <input type="text" id="empDesignation" placeholder="Designation" disabled>
        <input type="text" id="empSalary" placeholder="Monthly Salary" disabled>
      </div>

      <button id="submitQRBtn" class="submit-btn">Add Employee</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="updateModal" class="modal" >
  <div class="modal-content">
    <div class="modal-header">
      <h2>Update Employee Information</h2>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>

    <div class="tabsmodal">
      <div class="modal-tab active" data-tab="employee">Employee Information</div>
      <div class="modal-tab" data-tab="tab2modal">Mandatory Deductions</div>
      <div class="modal-tab" data-tab="tab3modal">Voluntary Deductions</div>
      <div class="modal-tab" data-tab="tab4modal">Attendance-Based Deductions</div>
    </div>

        <div class="modal-tab-content active" id="employee">
          <div class="input-group">
            <label for="empNameUp">Name</label>
            <input type="text" id="empNameUp" readonly>
          </div>
          <div class="empInfo">
            <div class="input-group">
              <label for="empIDUp">Employment Information</label>
              <input type="text" id="empIDUp" readonly>
              <input type="text" id="empAreaUp" readonly>
            </div>

            <div class="input-group" id="desSal">
              <input type="text" id="empDesignationUp" placeholder="Designation" disabled>
              <input type="number" id="empSalaryUp" placeholder="Salary" disabled>
              <!-- Toggle button -->
              <label class="switch">
                <input type="checkbox" id="toggleEditUpdate">
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>




       <div class="modal-tab-content" id="tab2modal">

        <div class="deduction-row">
          <p class="note">
            <b>SSS Computation Rule (2025):</b><br>
            - Monthly Salary Credit (MSC) = Salary rounded to nearest bracket (‚Ç±4,000 min, ‚Ç±30,000 max)<br>
            - Total Contribution = MSC √ó 15%<br>
            - Employee Share = MSC √ó 4.5%<br>
            - Employer Share = MSC √ó 8.5% + EC (‚Ç±10‚Äì‚Ç±30)
          </p>
          <div class="input-group">
            <label for="sssDeduction">SSS</label>
            <input type="number" id="sssDeduction" placeholder="MSC √ó 15%" disabled>
                <label class="switch">
                    <input type="checkbox" id="toggleSSS">
                    <span class="slider"></span>
                </label>
          </div>
        </div>

        <div class="deduction-row">
          <p class="note">
            <b>PhilHealth Computation Rule (2025):</b><br>
            - Premium Rate = 5% of Monthly Salary<br>
            - Salary Floor = ‚Ç±10,000 | Salary Ceiling = ‚Ç±100,000<br>
            - Total Contribution = Salary √ó 5% (min ‚Ç±10,000, max ‚Ç±100,000)<br>
            - Employee Share = 50% of Total Contribution<br>
            - Employer Share = 50% of Total Contribution
          </p>
          <div class="input-group">
            <label for="phicDeduction">PhilHealth</label>
            <input type="number" id="phicDeduction" placeholder="5% of salary (‚Ç±10k‚Äì‚Ç±100k)" disabled>
                 <label class="switch">
                    <input type="checkbox" id="togglePHIC">
                    <span class="slider"></span>
                </label>
          </div>
        </div>

        <div class="deduction-row">
          <p class="note">
            <b>Pag-IBIG Contribution Rule:</b><br>
            - Salary Ceiling = ‚Ç±5,000<br>
            - Employee Share = 1% (‚â§ ‚Ç±1,500) or 2% (> ‚Ç±1,500)<br>
            - Employer Share = 2%<br>
            - Total = Employee + Employer
          </p>
          <div class="input-group">
            <label for="hdmfDeduction">Pag-IBIG</label>
            <input type="number" id="hdmfDeduction" placeholder="1%/2% + 2% (‚Ç±5k max)" disabled>
                  <label class="switch">
                    <input type="checkbox" id="toggleHDMF">
                    <span class="slider"></span>
                </label>
          </div>
        </div>
      </div>

    <div class="modal-tab-content" id="tab3modal">
          <!-- Voluntary Deduction Row -->
          <div class="voluntary-row">
            <div class="input-group">
              <label for="volDeductionType">Deduction Type</label>
              <select id="volDeductionType" disabled>
                <option value="">-- Select Deduction --</option>
                <option value="salaryLoan">Salary Loan</option>
                <option value="calamityLoan">Calamity Loan</option>
                <option value="cashAdvance">Cash Advance (CA)</option>
                <option value="other">Other Deduction</option>
              </select>
            </div>

            <div class="input-group">
              <label for="volDeductionAmount">Amount</label>
              <input type="number" id="volDeductionAmount" placeholder="0.00" disabled>
            </div>
          </div>

          <!-- Cash Advance Options -->
          <div id="cashAdvanceOptions" class="cash-advance-box" style="display:none; margin-top:15px;">
            <label>
              <input type="checkbox" id="caInstallment"> Pay by Installment
            </label>

            <div class="ca-fields" style="display:none; margin-top:10px; gap:10px;">
              <div class="input-group">
                <label for="caTotal">Total Cash Advance</label>
                <input type="number" id="caTotal" placeholder="0.00">
              </div>

              <div class="input-group">
                <label for="caPerCutoff">Deduction per Cutoff</label>
                <input type="number" id="caPerCutoff" placeholder="0.00">
              </div>

                    <div class="ca-button-wrapper">
                      <button type="button" id="caConfirmBtn">OK</button>
                    </div>
            </div>
          </div>

          <!-- Dynamic Table (Hidden initially) -->
          <div id="caTableContainer" style="display:none; margin-top:15px; overflow-x:auto;">
            <table id="caTable" style="width:100%; border-collapse:collapse; min-width:300px;">
              <thead style="background:#f0f0f0;">
                <tr>
                  <th style="padding:8px; text-align:center;">Cutoff Date</th>
                  <th style="padding:8px; text-align:center;">Deduction</th>
                  <th style="padding:8px; text-align:center;">Remaining Balance</th>
                  <th style="padding:8px; text-align:center;">Status</th> <!-- bagong column -->
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Voluntary Toggle -->
          <div class="deduction-toggle" style="margin-top:20px;">
            <label class="switch">
              <input type="checkbox" id="voluntaryToggle">
              <span class="slider"></span>
            </label>
            <span class="toggle-label">Apply Voluntary Deductions</span>
          </div>
        </div>


       
                    <!-- Tab 4: Attendance-Based Deduction -->
            <div class="modal-tab-content" id="tab4modal">
              <p class="note">
                <b>Rate & Deduction Computation:</b><br>
                - <strong>Rate per Day</strong> = Monthly Salary √∑ 26 (o 30)<br>
                - <strong>Rate per Hour</strong> = Rate per Day √∑ 8<br>
                - <strong>Rate per Minute</strong> = Rate per Hour √∑ 60<br>
                - <strong>Deduction</strong> = (# of lates in minutes √ó rate/minute) + (undertime √ó rate/minute) + (absences √ó rate/day)
              </p>

                              <!-- Tab 4: Attendance-Based Deduction -->
                  <h4 style="margin-top: 10px;">Attendance-Based Deduction (This Month)</h4>
                  <table id="attendanceDeductionTable" border="1" style="width:100%; border-collapse: collapse; text-align:center;">
                    <thead style="background:#f1f1f1;">
                      <tr>
                        <th>Date</th>
                        <th>Late (min)</th>
                        <th>Undertime (min)</th>
                        <th>Deduction (‚Ç±)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="4">No data yet</td></tr>
                    </tbody>
                  </table>



              

        </div>
       <div style="padding: 16px 24px; text-align: right;">
      <button class="btn" id="saveUpdateBtn">Save</button>
    </div>
  </div>
</div>


      <!-- ADDITION MODAL -->
      <div id="additionModal" class="modal addition-modal">
        <div class="modal-content addition">
          <button class="close-btn" onclick="closeAdditionModal()">&times;</button>
          <h2>Employee Additional</h2>

          <!-- üîç Employee + Date -->
          <div class="form-row">
            <div class="form-group half">
              <label>Employee Name</label>
              <div class="input-wrapper">
                <input type="text" id="additionName" placeholder="Select Employee" readonly>
                <ul id="searchResults" class="dropdown-list"></ul>
              </div>
            </div>
            <div class="form-group half">
              <label>Effective Date</label>
              <input type="date" id="effectiveDate">
            </div>
          </div>

          <!-- üßæ Adjustment Type -->
          <div class="form-group">
            <label>Adjustment Type</label>
            <select id="adjustmentType">
              <option value="">Select Type</option>
              <option value="allowance">Allowance</option>
              <option value="restday">Restday</option>
              <option value="overtime">Overtime</option>
            </select>
          </div>

          <!-- üí∞ Static Input Fields -->
          <div id="staticFields">
            <div class="form-row">
              <div class="form-group half">
                <label>Hourly Rate (‚Ç±)</label>
                <input type="number" id="rate" placeholder="Enter hourly rate" disabled>
              </div>
              <div class="form-group half">
                <label>Hours Worked</label>
                <input type="number" id="hours" placeholder="Enter hours" disabled>
              </div>
            </div>

            <div class="form-group">
              <label>Amount (‚Ç±)</label>
              <input type="number" id="amount" placeholder="Enter amount" disabled>
            </div>

            <div class="form-group">
              <label>Remarks</label>
              <input type="text" id="remarks" placeholder="Enter reason or note">
            </div>
          </div>

          <!-- üíæ Actions -->
          <div class="modal-actions">
            <button class="save-btn" onclick="saveAddition()">üíæ Save</button>
            <button class="cancel-btn" onclick="closeAdditionModal()">Cancel</button>
          </div>

          <!-- üìä Table of Added Adjustments -->
          <h3 style="margin-top:25px;">üìã Added Adjustments</h3>
          <table id="addTable">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" style="text-align:center;">No records yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>



<div class="tab-content" id="tab3">
  <!-- Controls -->
  <div class="print-controls">
    <label>Date Covered:
      <input type="date" id="dateStart"> -
      <input type="date" id="dateEnd">
    </label>
    <button id="generatePayrollBtn">üìÖ Generate Payroll</button>
    <button onclick="window.print()">üñ® Print</button>
    <button onclick="downloadExcel()">‚¨á Download Excel</button>
  </div>

          <!-- Payroll Table -->
          <div class="table-container">
          <div id="tab3BodyContainer">
            <p style="text-align:center;">Loading...</p>
          </div>
        </div>
</div>


<div class="tab-content" id="tab4">
  <div class="print-controls">
   <label>Date Covered: 
      <input type="date" id="timeinStart"> - 
      <input type="date" id="timeinEnd">
    </label>
    <button onclick="loadTimeInArea()">üîç Apply Filter</button>
    <button onclick="window.print()">üñ® Print</button>
    <button onclick="downloadTimeInExcel()">‚¨á Download Excel</button>

  </div>

  <h3 style="text-align:center;margin:0;">SIMPAL GROUP OF COMPANIES</h3>
  <p style="text-align:center;margin:0;">TIME IN / TIME OUT REPORT</p>
  <p style="text-align:center;margin:0;">DATE COVERED: <span id="dateRangeLabel"></span></p>

  <div class="table-container">
    <table id="tab4Table" border="1">
      <colgroup>
        <col> <!-- 1st column: Employee Name -->
        <col span="n"> <!-- n = total number of date columns -->
      </colgroup>
      <thead id="tab4Head"></thead>
      <tbody id="tab4Body"></tbody>
    </table>
  </div>
</div>

<!-- üü¶ TAB 5: 13th Month Pay Computation -->

<div id="tab5" class="tab-content">
    <button onclick="window.print()">üñ® Print</button>
    <button onclick="downloadTimeInExcel()">‚¨á Download Excel</button>
  <div class="thirteenth-container">
    <h2 style="text-align:left;margin-left:290PX;">13th Month Pay January - December 2025 Computation</h2>

    <div class="table-wrapper">
      <table class="thirteenth-table">
        <!-- üëá Added colgroup for consistent column widths -->
        <colgroup>
          <col style="width: 230px;"> <!-- NAME -->
          <col span="13" style="width: 90px;"> <!-- JAN to YEAR -->
          <col style="width: 120px;"> <!-- 13TH MONTH PAY -->
        </colgroup>

        <thead>
          <tr>
            <th colspan="15">MONTHLY BASIC PAY</th>
          </tr>
          <tr class="months">
            <th>NAME</th>
            <th>JAN</th>
            <th>FEB</th>
            <th>MAR</th>
            <th>APR</th>
            <th>MAY</th>
            <th>JUN</th>
            <th>JUL</th>
            <th>AUG</th>
            <th>SEP</th>
            <th>OCT</th>
            <th>NOV</th>
            <th>DEC</th>
            <th>YEAR</th>
            <th>13 MONTH PAY</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>CHARMIE SIMPAL</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
          </tr>

          <tr>
            <td>JAY RYAN LIM</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
          </tr>

          <tr>
            <td>QUEENNIE LIM</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
          </tr>

          <tr class="total-row">
            <td>Total</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
            <td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td><td>‚Ç±0.00</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<script>


  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzxIw4N1eMDOvvyX_NqgBxW1NrzwSo-bvz6xn9Fw2nhmZPiXreP0RfZU9HsTK0Ezk0SlQ/exec"; 
  const SECRET_KEY = "jayryan"; // Secret key for AES


  // Open modal
function openPayrollModal() {
  const overlay = document.getElementById("payrollModalOverlay");
  const modal = document.getElementById("payrollModalBox");
  overlay.style.display = "flex";
  setTimeout(() => modal.classList.add("show"), 10);
  loadPayrollSettings(); // load dynamic rows
}

// Close modal
function closePayrollModal() {
  const overlay = document.getElementById("payrollModalOverlay");
  const modal = document.getElementById("payrollModalBox");
  modal.classList.remove("show");
  setTimeout(() => overlay.style.display = "none", 200);
}

// Load payroll settings dynamically
async function loadPayrollSettings() {
  const tbody = document.getElementById("payrollTableBody");
  tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

  try {
    // 1Ô∏è‚É£ Get dynamic areas from RATES
    const resRates = await fetch(`${WEB_APP_URL}?action=getRates`);
    const jsonRates = await resRates.json();
    const areas = [...new Set(jsonRates.map(item => item["AREA"]).filter(a => a))];

    // 2Ô∏è‚É£ Get saved payroll settings from RateSave
    const resSaved = await fetch(`${WEB_APP_URL}?action=getSavedPayrollSettings`);
    const jsonSaved = await resSaved.json();
    const savedData = Array.isArray(jsonSaved.data) ? jsonSaved.data : [];

    tbody.innerHTML = "";

    // 3Ô∏è‚É£ Populate rows with saved checkbox states
    areas.forEach(area => {
      const saved = savedData.find(r => r.AREA === area) || {};

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${area}</td>
        <td><input type="checkbox" class="fixed" ${saved.FIXED ? "checked" : ""}></td>
        <td><input type="checkbox" class="daily" ${saved.DAILY ? "checked" : ""}></td>
        <td><input type="checkbox" class="monthly" ${saved.MONTHLY ? "checked" : ""}></td>
        <td><input type="checkbox" class="semi" ${saved.SEMI ? "checked" : ""}></td>
        <td><input type="checkbox" class="weekly" ${saved.WEEKLY ? "checked" : ""}></td>
      `;
      tbody.appendChild(row);
    });

    addCheckboxLogic(); // mutual exclusivity

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="6" style="color:red;">Failed to load: ${err.message}</td></tr>`;
    console.error(err);
  }
}



function addCheckboxLogic() {
  const tbody = document.getElementById("payrollTableBody");
  const rows = tbody.querySelectorAll("tr");

  rows.forEach(row => {
    const rates = [row.querySelector(".fixed"), row.querySelector(".daily")];
    const cutoff = [row.querySelector(".monthly"), row.querySelector(".semi"), row.querySelector(".weekly")];

    // Function para i-handle mutual exclusivity
    function handleGroup(group) {
      group.forEach(cb => {
        if (!cb) return; // safety
        cb.addEventListener("change", () => {
          if (cb.checked) {
            group.forEach(other => {
              if (other !== cb) other.disabled = true;
            });
          } else {
            group.forEach(other => {
              if (other) other.disabled = false;
            });
          }
        });
      });

      // Initial state check
      const checked = group.find(cb => cb && cb.checked);
      if (checked) {
        group.forEach(cb => {
          if (cb !== checked) cb.disabled = true;
        });
      }
    }

    handleGroup(rates);
    handleGroup(cutoff);
  });
}

// Save payroll settings
async function savePayrollSettingsFrontend() {
  const tbody = document.getElementById("payrollTableBody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  // Collect data from each row
  const data = rows.map(tr => {
    const tds = tr.querySelectorAll("td");
    return {
      area: tds[0].innerText.trim(),
      fixed: tds[1].querySelector("input").checked,
      daily: tds[2].querySelector("input").checked,
      monthly: tds[3].querySelector("input").checked,
      semi: tds[4].querySelector("input").checked,
      weekly: tds[5].querySelector("input").checked,
      timestamp: new Date().toLocaleString()
    };
  });

  try {
    const res = await fetch(WEB_APP_URL, {
  method: "POST",
  body: JSON.stringify({ action: "savePayrollSettings", data }),
})


    const json = await res.json();

    if (json.success) {
      alert("‚úÖ Payroll settings saved successfully!");
    } else {
      alert("‚ùå Failed to save: " + json.message);
    }
  } catch (err) {
    console.error(err);
    alert("‚ùå Error saving data: " + err.message);
  }
}

  // ==============================
  // TOAST NOTIFICATION (optional)
  // ==============================
  function showToast(msg, isError = false) {
    let toast = document.createElement("div");
    toast.textContent = msg;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.padding = "10px 20px";
    toast.style.color = "#fff";
    toast.style.background = isError ? "#f44336" : "#4caf50";
    toast.style.borderRadius = "5px";
    toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
    toast.style.zIndex = 9999;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // ==============================
  // DROPDOWN EXAMPLE (settings)
  // ==============================
  const settingsBtn = document.querySelector('.settings-btn');
  const settingsDropdown = document.querySelector('.settings-dropdown');

  if (settingsBtn && settingsDropdown) {
    settingsBtn.addEventListener('click', () => settingsDropdown.classList.toggle('show'));
    window.addEventListener('click', e => {
      if (!e.target.closest('.settings-dropdown')) settingsDropdown.classList.remove('show');
    });
  }





if (!sessionStorage.getItem("loggedIn")) window.location.replace("login.html");

document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.clear();
  window.location.replace("login.html");
});




window.history.pushState(null,"",window.location.href);
window.addEventListener("popstate",()=>{if(!sessionStorage.getItem("loggedIn"))window.location.replace("login.html");else window.history.pushState(null,"",window.location.href);});

const toggleBtn = document.getElementById('themeToggle');
let darkMode = localStorage.getItem("theme") === "dark";

// Apply initial theme
applyTheme(darkMode);

toggleBtn.addEventListener('click', () => {
  darkMode = !darkMode;
  applyTheme(darkMode);
  localStorage.setItem("theme", darkMode ? "dark" : "light");
});

function applyTheme(isDark) {
  if (isDark) {
    document.documentElement.style.setProperty('--bg-color', '#1c1c1e');
    document.documentElement.style.setProperty('--text-color', '#f2f2f7');
    document.documentElement.style.setProperty('--card-bg', '#2c2c2e');
    document.documentElement.style.setProperty('--border-color', '#3a3a3c');
    document.documentElement.style.setProperty('--tab-active', '#0a84ff');
    toggleBtn.textContent = '‚òÄÔ∏è Light Mode';
  } else {
    document.documentElement.style.setProperty('--bg-color', '#f2f2f7');
    document.documentElement.style.setProperty('--text-color', '#1c1c1e');
    document.documentElement.style.setProperty('--card-bg', '#fff');
    document.documentElement.style.setProperty('--border-color', '#d1d1d6');
    document.documentElement.style.setProperty('--tab-active', '#007aff');
    toggleBtn.textContent = 'üåô Dark Mode';
  }
}


document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
    if(tab.dataset.tab==="tab2") loadRates();
    if(tab.dataset.tab==="tab3") loadTab3Data();
  });
});

document.querySelectorAll('#updateModal .modal-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const parent = tab.closest('.modal');

    // Remove active class sa lahat ng modal tabs at contents
    parent.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    parent.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));

    // Add active sa clicked tab at corresponding content
    tab.classList.add('active');
    const tabId = tab.dataset.tab;
    parent.querySelector(`#${tabId}`).classList.add('active');
  });
});


async function loadLogs() {
  const area = document.getElementById("areaFilter").value;
  const monthInput = document.getElementById("monthFilter");

  if (!monthInput.value) {
    const today = new Date();
    monthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`;
  }

  const month = monthInput.value;
  const search = document.getElementById("searchName").value.trim();
  const tbody = document.getElementById("logsTable");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "getLogs",
        area,
        month,
        search
      }),
    });

    const raw = await res.json();
    console.log("Fetched data:", raw);

    // ‚úÖ Make sure we use the correct array (depends on backend)
    const data = Array.isArray(raw) ? raw : raw.data || [];

    if (!data.length) {
      tbody.innerHTML = "<tr><td colspan='5'>No logs found</td></tr>";
      return;
    }

    data.sort((a, b) => new Date(b.date) - new Date(a.date));

    // ‚úÖ Populate area filter
    const uniqueAreas = [...new Set(data.map(r => r.area).filter(a => a))];
    const areaFilter = document.getElementById("areaFilter");
    areaFilter.innerHTML = '<option value="">All Areas</option>';
    uniqueAreas.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      areaFilter.appendChild(opt);
    });

    // ‚úÖ Render rows
    tbody.innerHTML = "";
    data.forEach(log => {
      const row = `
        <tr>
          <td>${log.name ? log.name.toUpperCase() : "UNKNOWN"}</td>
          <td>${log.area ? log.area.toUpperCase() : "-"}</td>
          <td>${formatTimeCell(log.timeIn)}</td>
          <td>${formatTimeCell(log.timeOut)}</td>
          <td>${log.date}</td>
        </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });

  } catch (err) {
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='5'>Error loading logs</td></tr>";
  }
}

function formatTimeCell(value) {
  if (!value) return "-";
  const date = new Date(value);
  if (isNaN(date)) return value;
  let h = date.getHours();
  const m = String(date.getMinutes()).padStart(2, '0');
  const ampm = h >= 12 ? "PM" : "AM";
  h = h % 12;
  h = h === 0 ? 12 : h;
  return `${h}:${m} ${ampm}`;
}

document.addEventListener("DOMContentLoaded", loadLogs);

// --- Employee Deductions ---
window.employeeRates = [];

async function loadRates() {
  const tbody = document.getElementById("ratesTable");
  tbody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({ action: "getRates" }),
    });

    const data = await res.json();

     console.log("üì¶ Rates data:", data);

    if (!data || data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7'>No rates found</td></tr>";
      return;
    }

    window.employeeRates = data.map(emp => ({
      id: emp.id || "",
      name: emp.employeeName || "UNKNOWN",
      area: emp.area || "-",
      designation: emp.designation || "-",
      monthlySalary: emp.monthlySalary
    ? Number(emp.monthlySalary).toFixed(2)
    : "0.00",

      // ‚úÖ include timeExempted from backend
      timeExempted: emp.timeExempted || "",

      // ‚úÖ optional fields for deductions (if used elsewhere)
      sssDeduction: emp.sssDeduction || "",
      phicDeduction: emp.phicDeduction || "",
      hdmfDeduction: emp.hdmfDeduction || "",
      applyMandatoryAll: emp.applyMandatoryAll || false,

      voluntaryDeduction: emp.voluntaryDeduction || "",
      voluntaryStart: emp.voluntaryStart || "",
      voluntaryEnd: emp.voluntaryEnd || "",
      attendanceDeduction: emp.attendanceDeduction || "",
    }));

    renderRatesTable(window.employeeRates);
  } catch (err) {
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='7'>Error loading rates</td></tr>";
  }
}



// ‚úÖ Render all employees in Rates Table with Time Exempted Toggle
function renderRatesTable(list) {
  const tbody = document.getElementById("ratesTable");
  tbody.innerHTML = list?.length
    ? ""
    : "<tr><td colspan='7'>No employees found</td></tr>";

  list?.forEach(emp => {
    const timeExempted = String(emp.timeExempted || "").trim().toUpperCase();
    const isExempted = timeExempted === "TRUE";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${emp.id}</td>
      <td>${emp.name || emp.employeeName}</td>
      <td>${emp.area}</td>
      <td>${emp.designation}</td>
      <td>‚Ç±${Number(emp.monthlySalary || emp.basicMonthlySalary || 0).toLocaleString("en-PH", { minimumFractionDigits: 2 })}</td>
      <td>
        <label class="switch">
          <input type="checkbox" class="exempt-toggle" data-id="${emp.id}" ${isExempted ? "checked" : ""}>
          <span class="slider"></span>
        </label>
      </td>
      <td>
        <button class="deduct-btn">‚ûñ</button>
        <button class="add-btn">‚ûï</button>
      </td>
    `;

    tbody.appendChild(row);

    row.querySelector(".deduct-btn").onclick = () => openUpdateEmployeeModal(emp);
    row.querySelector(".add-btn").onclick = () => openAdditionModal(emp);
  });

  document.querySelectorAll(".exempt-toggle").forEach(toggle => {
    toggle.addEventListener("change", async (e) => {
      const empId = e.target.dataset.id;
      const isExempted = e.target.checked;

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          body: new URLSearchParams({
            action: "updateExempted",
            empId,
            exempted: isExempted ? "TRUE" : "FALSE",
          }),
        });

        const result = await res.json();
        if (result.success) {
          console.log(`‚úÖ Updated ${empId}: Exempted = ${isExempted}`);
          // Uncomment to reload UI
          // loadRates();
        } else {
          alert(`‚ö†Ô∏è Failed to update exempted status for ${empId}`);
        }
      } catch (err) {
        console.error("‚ùå Error updating exempted status:", err);
      }
    });
  });
}

// ‚úÖ Open Additions Modal
function openAdditionModal(emp) {
  selectedEmployee = emp; // store full employee data globally
  const modal = document.getElementById("additionModal");
  modal.classList.add("show");

  document.getElementById("additionName").value = emp.name;
  document.getElementById("additionName").readOnly = true;

  // Auto-fill hourly rate for overtime
  updateHourlyRate();

  // Load employee additions
  fetchEmployeeAdditions(emp.id);
}

function closeAdditionModal() {
  const modal = document.getElementById("additionModal");
  modal.classList.remove("show");

  const idsToClear = ["effectiveDate", "adjustmentType", "rate", "hours", "amount", "remarks"];
  idsToClear.forEach(id => {
    const el = modal.querySelector("#" + id);
    if (el) {
      el.value = "";
      el.disabled = false; 
      el.readOnly = false; 
    }
  });
}

// ‚úÖ Compute overtime amount = rate √ó hours
function computeOvertime() {
  const rate = Number(document.getElementById("rate").value || 0);
  const hours = Number(document.getElementById("hours").value || 0);
  document.getElementById("amount").value = (rate * hours).toFixed(2);
}

// ---------------------------
// Global Variables
// ---------------------------
let selectedEmployee = null;
const additions = {}; // store additions keyed by empId


// ---------------------------
// Open Addition Modal
// ---------------------------
function openAdditionModal(emp) {
  selectedEmployee = emp; // store full employee data globally
  const modal = document.getElementById("additionModal");
  modal.classList.add("show");

  document.getElementById("additionName").value = emp.name;
  document.getElementById("additionName").readOnly = true;

  // Auto-fill hourly rate if Overtime
  updateHourlyRate();

  // Load employee additions by empId
  fetchEmployeeAdditions(emp.id);
}

// ---------------------------
// Close Addition Modal
// ---------------------------
function closeAdditionModal() {
  const modal = document.getElementById("additionModal");
  modal.classList.remove("show");

  // Clear input fields
  ["effectiveDate","adjustmentType","rate","hours","amount","remarks"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.value = "";
      el.disabled = false;
      el.readOnly = false;
    }
  });
}

// ---------------------------
// Fetch Employee Additions
// ---------------------------
async function fetchEmployeeAdditions(empId) {
  const tbody = document.querySelector("#addTable tbody");
  tbody.innerHTML = `<tr>
    <td colspan="5" style="text-align:center; font-style:italic; color:#888;">‚è≥ Loading data...</td>
  </tr>`;

  try {
    const response = await fetch(`${WEB_APP_URL}?action=getPayrollInput&empId=${encodeURIComponent(empId)}`);
    const result = await response.json();
    console.log(result);

    if (result.success && Array.isArray(result.records)) {
      // Store locally
      additions[empId] = result.records;
      renderAdditionsTable(empId);
    } else {
      additions[empId] = [];
      renderAdditionsTable(empId);
    }
  } catch (err) {
    console.error("Error fetching additions:", err);
    tbody.innerHTML = `<tr>
      <td colspan="5" style="text-align:center; color:red;">‚ö†Ô∏è Failed to load data</td>
    </tr>`;
  }
}

// ---------------------------
// Save Addition
// ---------------------------
async function saveAddition() {
  if (!selectedEmployee || !selectedEmployee.id) {
    alert("‚ö†Ô∏è Please select a valid employee.");
    return;
  }

  const empId = selectedEmployee.id;
  const empName = document.getElementById("additionName").value.trim();
  const type = document.getElementById("adjustmentType").value;
  const amount = parseFloat(document.getElementById("amount").value) || 0;
  const date = document.getElementById("effectiveDate").value;
  const remarks = document.getElementById("remarks").value.trim();

  if (!type || !date) {
    alert("‚ö†Ô∏è Please fill all required fields.");
    return;
  }

  const data = { empId, name: empName, type, amount, date, remarks };

  // Save locally
  if (!additions[empId]) additions[empId] = [];
  additions[empId].push(data);

  renderAdditionsTable(empId, { [empId]: additions[empId] });

  // Clear input fields
  ["adjustmentType","rate","hours","amount","remarks","effectiveDate"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = "";
  });

  // Save to Google Sheet
  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "savePayrollInput",
        ...data
      }).toString(),
    });
    const result = await res.json();
    if (result.success) console.log("‚úÖ Saved successfully!");
    else console.warn("‚ùå Save failed:", result.message);
  } catch (err) {
    console.error("‚ö†Ô∏è Error saving to Google Sheet:", err);
  }
}

// ---------------------------
// Render Additions Table
// ---------------------------
function renderAdditionsTable(empId) {
  const tbody = document.querySelector("#addTable tbody");
  tbody.innerHTML = "";

  const empRecords = additions[empId] || [];

  if (!empRecords.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#777;">No records yet</td></tr>`;
    return;
  }

  empRecords.forEach(item => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.name || "-"}</td>
      <td>${item.type}</td>
      <td>‚Ç±${Number(item.amount).toLocaleString("en-PH", { minimumFractionDigits: 2 })}</td>
      <td>${formatLocalDate(item.date)}</td>
      <td>${item.remarks || "-"}</td>
    `;
    tbody.appendChild(row);
  });
}
// ---------------------------
// Format Date
// ---------------------------
function formatLocalDate(dateStr) {
  if (!dateStr) return "-";
  try {
    const date = new Date(dateStr);
    return date.toISOString().split("T")[0];
  } catch {
    return dateStr;
  }
}
// ---------------------------
// Update Hourly Rate for Overtime
// ---------------------------
function updateHourlyRate() {
  if (!selectedEmployee) return;

  const adjustmentSelect = document.getElementById("adjustmentType");
  const rateInput = document.getElementById("rate");

  if (adjustmentSelect.value !== "overtime") {
    rateInput.value = "";
    return;
  }

  let baseRate = 0;
  if (selectedEmployee.rate && selectedEmployee.rate > 0) {
    baseRate = selectedEmployee.rate;
  } else if (selectedEmployee.monthlySalary && selectedEmployee.monthlySalary > 0) {
    baseRate = selectedEmployee.monthlySalary / (30 * 8);
    baseRate = parseFloat(baseRate.toFixed(2));
  } else {
    rateInput.value = "";
    return;
  }

  rateInput.value = baseRate;
  rateInput.disabled = false;

  computeOvertime();
}

// ---------------------------
// Compute Overtime Amount
// ---------------------------
const rateInput = document.getElementById("rate");
const hoursInput = document.getElementById("hours");
const amountInput = document.getElementById("amount");

function computeOvertime() {
  const rate = parseFloat(rateInput.value) || 0;
  const hours = parseFloat(hoursInput.value) || 0;
  amountInput.value = (rate * hours).toFixed(2);
}

// ---------------------------
// Adjustment Type Behavior
// ---------------------------
const adjustmentSelect = document.getElementById("adjustmentType");

adjustmentSelect.addEventListener("change", function() {
  const type = this.value;

  // Reset inputs
  [rateInput, hoursInput, amountInput].forEach(el => {
    el.disabled = true;
    el.readOnly = false;
    el.value = "";
  });

  if (type === "allowance" || type === "restday") {
    amountInput.disabled = false;
  } 
  else if (type === "overtime") {
    rateInput.disabled = false;
    hoursInput.disabled = false;
    amountInput.readOnly = true;

    rateInput.removeEventListener("input", computeOvertime);
    hoursInput.removeEventListener("input", computeOvertime);
    rateInput.addEventListener("input", computeOvertime);
    hoursInput.addEventListener("input", computeOvertime);

    updateHourlyRate();
  }
});








function openUpdateEmployeeModalById(btn) {
  const empId = btn.dataset.id;
  const emp = window.employeeRates.find(e => e.id === empId);
  if(!emp) return alert("Employee not found");
  openUpdateEmployeeModal(emp);
}


document.getElementById("rateSearch").addEventListener("input",()=>{
  const search=document.getElementById("rateSearch").value.toLowerCase();
  const filtered=window.employeeRates.filter(emp=>emp.name.toLowerCase().includes(search));
  renderRatesTable(filtered);
});




// ---------------- Tab3: Payroll Printing ----------------
async function loadTab3Data() {
  const container = document.getElementById("tab3BodyContainer");
  container.innerHTML = "<p style='text-align:center;'>Loading...</p>";

  const startInput = document.getElementById("dateStart").value;
  const endInput = document.getElementById("dateEnd").value;

  const dateText = startInput && endInput
    ? `DATE COVERED: ${startInput} - ${endInput}`
    : (startInput ? `DATE COVERED: FROM ${startInput}` : "DATE COVERED: ‚Äî");

  try {
    // 1Ô∏è‚É£ Fetch payroll data from backend
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "payroll",
        startDate: startInput,
        endDate: endInput
      })
    });
    const result = await res.json();

    if (!result.success) {
      container.innerHTML = "<p style='text-align:center; color:red;'>No payroll data available</p>";
      return;
    }

    const payrollData = result.data || [];
    console.log("Payroll Data:", payrollData);

    // 2Ô∏è‚É£ Group employees by area
    const grouped = {};
    payrollData.forEach(emp => {
      const area = emp.area || "UNASSIGNED";
      if (!grouped[area]) grouped[area] = [];
      grouped[area].push(emp);
    });

    container.innerHTML = "";

    // 3Ô∏è‚É£ Render payroll table per area
    Object.keys(grouped).forEach(area => {
      const employees = grouped[area];
      if (!employees.length) return;

      let totalMonthly = 0;
      let totalNet = 0;

      let html = `
        <div class="company-header">
          <h3>SIMPAL GROUP OF COMPANIES</h3>
          <p>${area.toUpperCase()} OFFICE</p>
          <p>SALARY AND COMPENSATION</p>
          <p>${dateText}</p>
        </div>

        <table class="area-table" border="1">
          <thead class="table-header">
            <tr>
              <th>EMPLOYEE NAME</th>
              <th>DESIGNATION</th>
              <th>BASIC MONTHLY SALARY</th>
              <th>RATE PER DAY</th>
              <th>RATE PER HOUR</th>
              <th># OF DAYS</th>
              <th>TOTAL BASIC PAY</th>
              <th>ALLOWANCE</th>
              <th>RESTDAY</th>
              <th>OVERTIME</th>
              <th>PHIC</th>
              <th>HDMF</th>
              <th>SSS</th>
              <th>SALARY ADVANCEMENT</th>
              <th>LATE/UNDERTIME</th>
              <th>NET PAY</th>
              <th>SIGNATURE</th>
            </tr>
          </thead>
          <tbody>
      `;

      employees.forEach(emp => {
        html += `
          <tr>
            <td>${emp.name}</td>
            <td>${emp.designation}</td>
            <td>${Number(emp.monthly).toLocaleString()}</td>
            <td>${Number(emp.ratePerDay).toFixed(2)}</td>
            <td>${Number(emp.ratePerHour).toFixed(2)}</td>
            <td>${Number(emp.daysWorked)}</td>
            <td>${Number(emp.totalBasic).toLocaleString()}</td>
            <td>${Number(emp.allowance).toLocaleString()}</td>
            <td>${Number(emp.restday).toLocaleString()}</td>
            <td>${Number(emp.overtime).toLocaleString()}</td>
            <td>${Number(emp.phic).toLocaleString()}</td>
            <td>${Number(emp.hdmf).toLocaleString()}</td>
            <td>${Number(emp.sss).toLocaleString()}</td>
            <td>${Number(emp.voluntary || 0).toLocaleString()}</td>
            <td>${Number(emp.lateUndertimeDeduction).toLocaleString()}</td>
            <td>${Number(emp.netPay).toLocaleString()}</td>
            <td></td>
          </tr>
        `;

        totalMonthly += Number(emp.monthly);
        totalNet += Number(emp.netPay);
      });

      html += `
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td colspan="2">TOTAL (${area.toUpperCase()})</td>
              <td>${totalMonthly.toLocaleString()}</td>
              <td colspan="12"></td>
              <td>${totalNet.toLocaleString()}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      `;

      container.insertAdjacentHTML("beforeend", html);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = "<p style='text-align:center; color:red;'>Error loading payroll data</p>";
  }
}

document.getElementById("generatePayrollBtn").addEventListener("click", loadTab3Data);



// ---------------- Download Excel ----------------
function downloadExcel(){
  const table = document.getElementById("tab3Table").outerHTML;
  const html=`<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body>${table}</body></html>`;
  const blob=new Blob([html],{type:"application/vnd.ms-excel"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="payroll_tab3.xls";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
function computeTotals(){
  const tbody = document.getElementById("tab3Body");
  const rows = tbody.querySelectorAll("tr");
  const totalRow = document.getElementById("totalRow");
  const totalCells = totalRow.querySelectorAll("td");

  // initialize totals per column
  let totals = Array(totalCells.length).fill(0);

  rows.forEach(row=>{
    const cells = row.querySelectorAll("td");
    cells.forEach((cell,i)=>{
      let val = cell.textContent.replace(/,/g,"").trim(); 
      if(!isNaN(val) && val !== "" && i >= 2 && i <= 15){ 
        totals[i] += parseFloat(val);
      }
    });
  });

  // apply totals
  totals.forEach((t,i)=>{
    if(i >= 2 && i <= 15){
      totalCells[i].textContent = t.toLocaleString(undefined,{
        minimumFractionDigits:0,
        maximumFractionDigits:2
      });
    }
  });
}
// --- QR Modal ---
const qrModal = document.getElementById("qrModal");
const openQrBtn = document.getElementById("scanQRBtn");
const closeQrBtn = document.getElementById("closeQrModal");
const qrInput = document.getElementById("qrInput");

// Track last scanned QR ID to prevent duplicates
let lastScanId = null;

openQrBtn.addEventListener("click", () => {
  qrModal.classList.add("show");
  qrInput.value = "";
  qrInput.focus();
});

closeQrBtn.addEventListener("click", () => {
  qrModal.classList.remove("show");

   // Clear all modal inputs
  document.getElementById("qrInput").value = "";
  document.getElementById("empID").value = "";
  document.getElementById("empName").value = "";
  document.getElementById("empArea").value = "";
  empDesignation.value = "";
  empSalary.value = "";

  // Reset toggle and disable fields
  empDesignation.disabled = true;
  empSalary.disabled = true;
  toggleEditBtnAdd.textContent = "Edit Details";
});

window.addEventListener("click", e => { if(e.target===qrModal) qrModal.classList.remove("show"); });

// --- Function to open modals dynamically ---
function openModal(modalId){
  document.getElementById(modalId).classList.add("show");
}
function closeModal(modalId){

  const modal = document.getElementById(modalId);modal.classList.remove("show");

  const inputs = modal.querySelectorAll("input");
  inputs.forEach(input => input.value = "");
}

// --- Toggle Designation & Salary ---
const toggleEditBtnAdd = document.getElementById("toggleEditBtnAdd");
const empDesignation = document.getElementById("empDesignation");
const empSalary = document.getElementById("empSalary");

toggleEditBtnAdd.addEventListener("click", () => {
  const editable = empDesignation.disabled; // true if currently disabled
  empDesignation.disabled = !editable;
  empSalary.disabled = !editable;
  empDesignation.style.backgroundColor = editable ? "#fff" : "#f0f0f0";
  empSalary.style.backgroundColor = editable ? "#fff" : "#f0f0f0";
  toggleEditBtnAdd.textContent = editable ? "Lock Details" : "Edit Details";
});

const toggleEditUpdate = document.getElementById("toggleEditUpdate");
const empDesignationUp = document.getElementById("empDesignationUp");
const empSalaryUp = document.getElementById("empSalaryUp");

// toggle handler
toggleEditUpdate.addEventListener("change", () => {
  if (toggleEditUpdate.checked) {
    empDesignationUp.disabled = false;
    empSalaryUp.disabled = false;
    empDesignationUp.style.backgroundColor = "#fff";
    empSalaryUp.style.backgroundColor = "#fff";
  } else {
    empDesignationUp.disabled = true;
    empSalaryUp.disabled = true;
    empDesignationUp.style.backgroundColor = "#e9ecef";
    empSalaryUp.style.backgroundColor = "#e9ecef";
  }
});

// ‚úÖ force reset on page load
window.addEventListener("load", () => {
  toggleEditUpdate.checked = false;
  empDesignationUp.disabled = true;
  empSalaryUp.disabled = true;
  empDesignationUp.style.backgroundColor = "#e9ecef";
  empSalaryUp.style.backgroundColor = "#e9ecef";
});







// --- Pending Employees after QR scan ---
window.pendingEmployees = [];


// Render pending employees table
function renderPendingEmployees(){
  const tbody = document.getElementById("ratesTable");
  tbody.innerHTML = "";

  if(window.pendingEmployees.length === 0){
    tbody.innerHTML = "<tr><td colspan='6'>No employees scanned</td></tr>";
    return;
  }

  window.pendingEmployees.forEach(emp => {
    const row = document.createElement("tr");

    // Highlight if designation or salary is blank
    let highlightClass = "";
    if(!emp.designation || !emp.salary) highlightClass = "incomplete";

    row.innerHTML = `
      <td class="${highlightClass}">${emp.id}</td>
      <td class="${highlightClass}">${emp.name}</td>
      <td class="${highlightClass}">${emp.area}</td>
      <td class="${highlightClass}">${emp.designation || "-"}</td>
      <td class="${highlightClass}">${emp.salary ? "‚Ç±" + Number(emp.salary).toFixed(2) : "-"}</td>
      <td>
        <button onclick='editPendingEmployee("${emp.id}")'>‚úèÔ∏è Update</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Edit employee from pending table
function editPendingEmployee(empId){
  const emp = window.pendingEmployees.find(e => e.id === empId);
  if(!emp) return alert("Employee not found");

  // Fill modal
  document.getElementById("empID").value = emp.id;
  document.getElementById("empName").value = emp.name;
  document.getElementById("empArea").value = emp.area;
  empDesignation.value = emp.designation || "";
  empSalary.value = emp.salary || "";

  // Enable editing
  empDesignation.disabled = false;
  empSalary.disabled = false;
  empDesignation.style.backgroundColor = "#fff";
  empSalary.style.backgroundColor = "#fff";
  toggleEditBtn.textContent = "Lock Details";

  // Remove from pending array (will re-add on submit)
  window.pendingEmployees = window.pendingEmployees.filter(e => e.id !== empId);
  renderPendingEmployees();

  qrModal.classList.add("show");
}

// Add CSS for incomplete highlight dynamically (optional if not in CSS file)
const style = document.createElement('style');
style.textContent = `
  .incomplete {
    background-color: #fff3cd;
    font-weight: bold;
  }
`;
document.head.appendChild(style);

function decryptQR(encrypted) {
  try {
    const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8);

    if (!decrypted) {
      console.error("‚ö†Ô∏è Empty decrypted text - possible wrong key or corrupted QR.");
      return null;
    }

    return JSON.parse(decrypted);
  } catch (err) {   
    console.error("Decryption error:", err);
    return null;
  }
}

// --- Prevent bad paste characters ---
qrInput.addEventListener("paste", (e) => {
  e.preventDefault();
  let paste = (e.clipboardData || window.clipboardData).getData('text');
  paste = paste.trim().replace(/[\r\n\t]+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '');
  qrInput.value = paste;
});

// --- QR input handling ---
qrInput.addEventListener("keydown", (e) => {
  if (e.key !== "Enter") return;
  e.preventDefault();

  let qrData = qrInput.value.trim().replace(/[\r\n\t]+/g, '');
  if(!qrData) return;

  let data;
  try {
    data = decryptQR(qrData);
    if(!data) throw new Error("Invalid QR");
  } catch(err) {
    alert("Invalid or corrupted QR code!");
    qrInput.value = "";
    return;
  }

  // Prevent same QR from being scanned repeatedly
  if(data.id === lastScanId) {
    alert("‚ö†Ô∏è This QR has already been scanned!");
    qrInput.value = "";
    return;
  }
  lastScanId = data.id;

  // Auto-fill inputs
  document.getElementById("empID").value = data.id || "";
  document.getElementById("empName").value = data.name || "";
  document.getElementById("empArea").value = data.area || "";
  empDesignation.value = data.designation || "";
  empSalary.value = data.salary || "";
  empDesignation.disabled = true;
  empSalary.disabled = true;
  toggleEditBtn.textContent = "Edit Details";

  qrInput.value = "";

  // Optional auto-clear modal fields after 10 seconds (non-intrusive)
  setTimeout(() => {
    if(qrModal.classList.contains("show")) return; // do not clear if modal still open
    document.getElementById("empID").value = "";
    document.getElementById("empName").value = "";
    document.getElementById("empArea").value = "";
    empDesignation.value = "";
    empSalary.value = "";
  }, 10000);
});
// --- Add Employee to Google Sheet ---
document.getElementById("submitQRBtn").addEventListener("click", async () => {
  const id = document.getElementById("empID").value.trim();
  const name = document.getElementById("empName").value.trim();
  const area = document.getElementById("empArea").value.trim();
  const designation = empDesignation.value.trim();
  const salary = empSalary.value.trim();

  if (!id || !name || !area) {
    alert("‚ö†Ô∏è Employee ID, Name, and Area are required!");
    return;
  }

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "addEmployee",
        id,
        name,
        area,
        designation,
        salary
      })
    });

    const result = await res.json();
    console.log("Backend response:", result);
    if (result.success) {
      alert("‚úÖ Employee added successfully!");

      // refresh rates table
      loadRates();

      // close modal
      qrModal.classList.remove("show");

      // clear fields
      document.getElementById("empID").value = "";
      document.getElementById("empName").value = "";
      document.getElementById("empArea").value = "";
      empDesignation.value = "";
      empSalary.value = "";
    } else {
      alert(result.message || "‚ùå Failed to add employee!");
    }
  } catch (err) {
    console.error("Add Employee error:", err);
    alert("‚ö†Ô∏è Error saving employee!");
  }
});


let employeesData = [];

// ----------------------
// 1Ô∏è‚É£ Preload all employees
// ----------------------
function preloadEmployees() {
  fetch(`${WEB_APP_URL}?action=getAllEmployeesWithDeductions`)
    .then(res => res.json())
    .then(data => {
      employeesData = data; // lahat ng deductions kasama
      renderRatesTable(data); // optional kung gusto mo ipakita sa table
    })
    .catch(err => console.error("Failed to preload employees:", err));
}




async function openUpdateEmployeeModal(emp) {
  console.log("EMP object received:", emp);

  // --- Fill basic info ---
  document.getElementById("empNameUp").value = emp.name || "";
  document.getElementById("empIDUp").value = emp.id || "";
  document.getElementById("empAreaUp").value = emp.area || "";
  document.getElementById("empDesignationUp").value = emp.designation || "";
  document.getElementById("empSalaryUp").value = emp.monthlySalary || "";

  // --- Fill mandatory deductions ---
  document.getElementById("phicDeduction").value = emp.phicDeduction || 0;
  document.getElementById("hdmfDeduction").value = emp.hdmfDeduction || 0;
  document.getElementById("sssDeduction").value = emp.sssDeduction || 0;

  // --- Lock fields not editable ---
  document.getElementById("empDesignationUp").disabled = true;
  document.getElementById("empSalaryUp").disabled = true;

  // --- Show modal ---
  const modal = document.getElementById("updateModal");
  modal.classList.add("show");
  modal.style.display = "flex";

  // ‚úÖ Load attendance-based deductions
  await loadAttendanceDeductions(emp);
}


// ---------------------------
// üîπ Load Attendance-Based Deductions (only shows days with late/undertime)
// ---------------------------
async function loadAttendanceDeductions(emp) {
  const tableBody = document.querySelector("#attendanceDeductionTable tbody");
  tableBody.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

  try {
    // üìÖ Set date range for the current month
    const now = new Date();
    const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split("T")[0];
    const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split("T")[0];

    // üì° Fetch payroll data from backend
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "payroll",
        empId: emp.id,
        startDate,
        endDate
      })
    });

    const result = await response.json();
    console.log("Attendance deduction result:", result);

    if (!result.success || !result.data) {
      tableBody.innerHTML = `<tr><td colspan="4">Walang attendance record.</td></tr>`;
      return;
    }

    // üîé Hanapin ang record ng empleyado
    const employeeData = result.data.find(item => item.empId === emp.id);
    if (!employeeData) {
      tableBody.innerHTML = `<tr><td colspan="4">Walang data para sa empleyadong ito.</td></tr>`;
      return;
    }

    const monthlySalary = parseFloat(emp.monthlySalary || 0);
    const ratePerMinute = monthlySalary / 30 / 8 / 60;

    // üìã Filter attendance only with late/undertime
    const attRows = (employeeData.attendance || []).filter(r => {
      return (parseFloat(r.lateMin || 0) > 0 || parseFloat(r.undertimeMin || 0) > 0);
    });

    if (attRows.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="4">üéâ Walang late o undertime sa buwang ito!</td></tr>`;
      return;
    }

    // üßÆ Build table rows
    let totalLate = 0;
    let totalUnder = 0;
    let totalDeduction = 0;

    const rowsHTML = attRows.map(r => {
      const date = r.date || "";
      const lateMin = parseFloat(r.lateMin || 0);
      const underMin = parseFloat(r.undertimeMin || 0);
      const deduction = (lateMin + underMin) * ratePerMinute;

      totalLate += lateMin;
      totalUnder += underMin;
      totalDeduction += deduction;

      return `
        <tr>
          <td>${date}</td>
          <td>${lateMin.toFixed(0)}</td>
          <td>${underMin.toFixed(0)}</td>
          <td>‚Ç±${deduction.toFixed(2)}</td>
        </tr>`;
    }).join("");

    // ‚ûï Add total summary row
    const totalRow = `
      <tr style="background:#f9f9f9; font-weight:bold;">
        <td>Total</td>
        <td>${totalLate.toFixed(0)}</td>
        <td>${totalUnder.toFixed(0)}</td>
        <td>‚Ç±${totalDeduction.toFixed(2)}</td>
      </tr>`;

    tableBody.innerHTML = rowsHTML + totalRow;

  } catch (err) {
    console.error(err);
    tableBody.innerHTML = `<tr><td colspan="4" style="color:red;">‚ùå Error sa pag-load ng attendance data.</td></tr>`;
  }
}
// ----------------------
// 4Ô∏è‚É£ Preload Employees
// ----------------------
document.addEventListener("DOMContentLoaded", preloadEmployees);



// ‚úÖ Move this outside the function
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("updateModal").classList.remove("show");

  // Optional: clear all fields
  const inputs = document.getElementById("updateModal").querySelectorAll("input");
  inputs.forEach(i => i.value = "");
});

  
// ========================
// SAVE / UPDATE BUTTON
// ========================
document.getElementById("saveUpdateBtn").addEventListener("click", async () => {
  const activeTab = document.querySelector(".modal-tab-content.active");
  if (!activeTab) {
    alert("‚ö†Ô∏è No active tab detected!");
    return;
  }

  const id = document.getElementById("empIDUp").value.trim();
  if (!id) {
    alert("‚ö†Ô∏è Missing Employee ID!");
    return;
  }

  try {
    let action = "";
    let body = {};

    // --- TAB 1: Employee Info ---
    if (activeTab.id === "employee") {
      const name = document.getElementById("empNameUp").value.trim();
      const area = document.getElementById("empAreaUp").value.trim();
      const designation = document.getElementById("empDesignationUp").value.trim();
      const salary = document.getElementById("empSalaryUp").value.trim();

      if (!name) return alert("‚ö†Ô∏è Please fill in Employee Name!");

      action = "updateEmployee";
      body = { id, name, area, designation, salary };
    }

    // --- TAB 2: Mandatory Deductions ---
    else if (activeTab.id === "tab2modal") {
      const sss = document.getElementById("sssDeduction")?.value.trim() || "";
      const phic = document.getElementById("phicDeduction")?.value.trim() || "";
      const hdmf = document.getElementById("hdmfDeduction")?.value.trim() || "";

      action = "saveMandatoryDeductions";
      body = { id, sss, phic, hdmf };
    }

    // --- TAB 3: Voluntary Deductions ---
    else if (activeTab.id === "tab3modal") {
      const tableRows = document.querySelectorAll("#caTable tbody tr");
      const volType = document.getElementById("volDeductionType")?.value || "N/A";
      const deductions = [];

      tableRows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length >= 3) {
          deductions.push({
            cutoffDate: cells[0].textContent.trim(),
            deduction: cells[1].textContent.trim(),
            remaining: cells[2].textContent.trim(),
            type: volType,
            createdDate: new Date().toLocaleDateString("en-US")
          });
        }
      });

      if (deductions.length === 0) {
        alert("‚ö†Ô∏è No Cash Advance data found!");
        return;
      }

      action = "saveVoluntaryDeductions";
      body = { id, deductions: JSON.stringify(deductions) };
    }

    // üü© ADD THIS LINE BEFORE FETCH:
    console.log("üì§ Sending to backend:", { action, ...body });

    // --- Send to backend ---
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({ action, ...body }),
    });

    // üß© Debugging section
    const text = await res.text();
    console.log("üîç RAW RESPONSE:", text);

    let result;
    try {
      result = JSON.parse(text);
      console.log("‚úÖ Parsed JSON:", result);
    } catch (err) {
      console.error("‚ùå JSON Parse Error:", err);
      alert("‚ùå Backend did not return valid JSON! Check Apps Script logs.");
      return;
    }

    // ‚úÖ Handle result
    if (result.success) {
      alert("‚úÖ " + (result.message || "Data saved successfully!"));
      document.getElementById("updateModal").classList.remove("show");
      loadRates(); // reload employee table
    } else {
      alert("‚ö†Ô∏è " + (result.message || "Failed to save data. Please check backend logs."));
    }

  } catch (err) {
    console.error("Error saving data:", err);
    alert("‚ùå Error while saving data!");
  }
});

// --- Variables ---
// --- Scope everything inside Tab 3 modal ---
const tab3 = document.getElementById("tab3modal");

// Elements
const volToggle = tab3?.querySelector("#voluntaryToggle");
const volDeductionType = tab3?.querySelector("#volDeductionType");
const volDeductionAmount = tab3?.querySelector("#volDeductionAmount");
const caOptions = tab3?.querySelector("#cashAdvanceOptions");
const caInstallment = tab3?.querySelector("#caInstallment");
const caFields = tab3?.querySelector(".ca-fields");

const caTotal = tab3?.querySelector("#caTotal");
const caPerCutoff = tab3?.querySelector("#caPerCutoff");
const caConfirmBtn = tab3?.querySelector("#caConfirmBtn");
const caTableContainer = tab3?.querySelector("#caTableContainer");
const caTableBody = tab3?.querySelector("#caTable tbody");

// Safety: make sure all elements exist
if(!volToggle || !volDeductionType || !volDeductionAmount) {
  console.warn("Tab 3 voluntary deduction elements not found. Skipping Tab 3 JS.");
} else {

  // --- Voluntary Toggle ---
  volToggle.addEventListener("change", function(){
    const enabled = this.checked;
    volDeductionType.disabled = !enabled;
    volDeductionAmount.disabled = !enabled;

    if(!enabled){
      volDeductionType.value = "";
      volDeductionAmount.value = "";
      caOptions.style.display = "none";
      caInstallment.checked = false;
      caFields.style.display = "none";
      caTableContainer.style.display = "none";
      caTotal.value = "";
      caPerCutoff.value = "";
      caTableBody.innerHTML = "";
    }
  });

  // --- Cash Advance Selection ---
  volDeductionType.addEventListener("change", function(){
    if(this.value === "cashAdvance"){
      volDeductionAmount.disabled = true;
      volDeductionAmount.value = "";
      caOptions.style.display = "block";
      caFields.style.display = "none";
      caTableContainer.style.display = "none";
    } else {
      volDeductionAmount.disabled = this.value === "";
      caOptions.style.display = "none";
      caInstallment.checked = false;
      caFields.style.display = "none";
      caTableContainer.style.display = "none";
      caTableBody.innerHTML = "";
    }
  });

  // --- Installment Checkbox ---
  caInstallment.addEventListener("change", function(){
    caFields.style.display = this.checked ? "grid" : "none";
    caTableContainer.style.display = "none"; // hide table until OK
  });

  // --- Confirm Button (show table only after OK) ---
  caConfirmBtn.addEventListener("click", function(){
    const total = parseFloat(caTotal.value) || 0;
    const perCutoff = parseFloat(caPerCutoff.value) || 0;

    if(total <= 0 || perCutoff <= 0){
      alert("Please enter valid amounts.");
      return;
    }

    if(perCutoff > total){
      alert("Per cutoff deduction cannot exceed total amount.");
      return;
    }

    generateCATable(total, perCutoff);
    caTableContainer.style.display = "block"; // show table after confirm
  });

  // --- Generate Table ---
  function generateCATable(total, perCutoff){
  caTableBody.innerHTML = '';
  let balance = total;
  const today = new Date();
  const cutoffs = [];

  // Generate next 6 cutoffs (15th & 30th pattern)
  for(let i=0; i<8; i++){
    const monthOffset = Math.floor(i/2) + ((today.getDate()>15 && i%2===0)?1:0);
    const month = today.getMonth() + monthOffset;
    const year = today.getFullYear() + Math.floor(month/12);
    const m = month % 12;
    const day = i%2 === 0 ? 15 : 30;
    cutoffs.push(new Date(year, m, day));
  }

  // Sort cutoffs ascending
  cutoffs.sort((a,b) => a - b);

  cutoffs.forEach(date => {
    if(balance <= 0) return;
    const deduction = Math.min(perCutoff, balance);
    balance -= deduction;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:6px; text-align:center;">${date.toLocaleDateString()}</td>
      <td style="padding:6px; text-align:center;">${deduction.toFixed(2)}</td>
      <td style="padding:6px; text-align:center;">${balance.toFixed(2)}</td>
    `;
    caTableBody.appendChild(tr);
  });
}

// --- Universal toggle setup for any tab ---
function setupToggle(toggleId, inputId) {
  const toggle = document.getElementById(toggleId);
  const input = document.getElementById(inputId);

  if (!toggle || !input) return;

  // initial state
  input.disabled = true;
  input.style.backgroundColor = "#f1f1f1";
  input.style.fontStyle = "italic";
  input.style.color = "#555";

  toggle.addEventListener("change", () => {
    if (toggle.checked) {
      input.disabled = false;
      input.style.backgroundColor = "#fff";
      input.style.fontStyle = "normal";
      input.style.color = "#000";
    } else {
      input.disabled = true;
      input.style.backgroundColor = "#f1f1f1";
      input.style.fontStyle = "italic";
      input.style.color = "#555";
    }
  });
}

// ‚úÖ Apply setup to all deduction toggles (Tab 2 + Tab 3)
setupToggle("toggleSSS", "sssDeduction");
setupToggle("togglePHIC", "phicDeduction");
setupToggle("toggleHDMF", "hdmfDeduction");
setupToggle("voluntaryToggle", "volDeductionAmount");

// ‚úÖ When saving, reset all toggles to default (disabled)
document.getElementById("saveUpdateBtn").addEventListener("click", () => {
  const toggleInputPairs = [
    ["toggleSSS", "sssDeduction"],
    ["togglePHIC", "phicDeduction"],
    ["toggleHDMF", "hdmfDeduction"],
    ["voluntaryToggle", "volDeductionAmount"]
  ];

  toggleInputPairs.forEach(([toggleId, inputId]) => {
    const toggle = document.getElementById(toggleId);
    const input = document.getElementById(inputId);
    if (toggle && input) {
      toggle.checked = false;
      input.disabled = true;
      input.style.backgroundColor = "#f1f1f1";
      input.style.fontStyle = "italic";
      input.style.color = "#555";
    }
  });

  alert("Deductions saved successfully!");
});



document.querySelectorAll('.ios-tab--dropdown').forEach(tab => {
  tab.addEventListener('click', function (e) {
    e.stopPropagation(); // para hindi agad magsara

    let dropdownId = this.getAttribute('data-dropdown');
    let dropdown = document.getElementById(dropdownId);

    // isara muna lahat ng dropdowns
    document.querySelectorAll('.ios-dropdown').forEach(menu => {
      if (menu !== dropdown) menu.style.display = "none";
    });

    // toggle yung napiling dropdown
    dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
  });
});

// kapag nag-click sa labas ng header, isasara lahat ng dropdowns
window.addEventListener('click', function () {
  document.querySelectorAll('.ios-dropdown').forEach(menu => {
    menu.style.display = "none";
  });
});

// Attendance Logs (main tab button)
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    // remove all active
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));

    // activate selected
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// Dropdown links (Adjustments + Reports)
document.querySelectorAll("[data-target]").forEach(link=>{
  link.addEventListener("click", function(e){
    e.preventDefault();

    const targetId = this.dataset.target;

    // remove all active
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));

    // activate the selected section
    document.getElementById(targetId).classList.add("active");

    // load functions kung meron
    if(targetId==="tab2") loadRates();
    if(targetId==="tab3") loadTab3Data(); // payroll na ito
    if(targetId==="tab4") loadTimeInArea();
    if(targetId==="tab5") load13thMonth();
  });
});

  function formatTime(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return "-"; // kapag invalid
    return d.toLocaleTimeString("en-PH", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true
    });
  }

  //----------addition modal-----------//




function renderTimeInOutReport(logs) {
  const table = document.getElementById("tab4Table");
  const tableHead = document.getElementById("tab4Head");
  const tableBody = document.getElementById("tab4Body");

  tableHead.innerHTML = "";
  tableBody.innerHTML = "";
  table.querySelector("colgroup")?.remove(); // Remove old colgroup if any

  if (!logs || logs.length === 0) {
    tableBody.innerHTML = "<tr><td colspan='100%'>Set Date Range</td></tr>";
    return;
  }

  // ‚úÖ Get all areas and employees
  const allAreas = [...new Set(logs.map(l => l.area))];

  // ‚úÖ Apply date range filter
  const startDate = document.getElementById("timeinStart").value;
  const endDate = document.getElementById("timeinEnd").value;
  const start = startDate ? new Date(startDate) : null;
  const end = endDate ? new Date(endDate) : null;

  // ‚úÖ Filter logs within range
  const filteredLogs = logs.filter(l => {
    const logDate = new Date(l.date);
    if (start && logDate < start) return false;
    if (end && logDate > end) return false;
    return true;
  });

  // ‚úÖ Get all unique dates
  const allDates = [...new Set(filteredLogs.map(l => l.date))].sort();

  if (allDates.length === 0) {
    tableBody.innerHTML = "<tr><td colspan='100%'>No records found in date range</td></tr>";
    return;
  }

  // ‚úÖ Build <colgroup> dynamically (compact layout)
  const colgroupHTML = `
    <colgroup>
      <col style="width:180px;"> <!-- Employee Name -->
      ${allDates.map(() => `<col style="width:48px;"><col style="width:48px;">`).join("")}
    </colgroup>`;
  table.insertAdjacentHTML("afterbegin", colgroupHTML);

  // ‚úÖ Group logs by area ‚Üí employee ‚Üí date
  const groupedByArea = {};
  logs.forEach(log => {
    if (!groupedByArea[log.area]) groupedByArea[log.area] = {};
    if (!groupedByArea[log.area][log.name]) groupedByArea[log.area][log.name] = {};
    groupedByArea[log.area][log.name][log.date] = log;
  });

  // ‚úÖ Render each area block
  allAreas.forEach(areaName => {
    const areaEmployees = groupedByArea[areaName] || {};

    // --- AREA HEADER ROW ---
    const areaTitle = `
      <tr class="areaRow">
        <td colspan="${1 + allDates.length * 2}" 
            style="font-weight:bold; background:#bfdbfe; text-align:center; font-size:15px;">
          AREA: ${areaName}
        </td>
      </tr>`;
    tableBody.innerHTML += areaTitle;

    // --- DATE HEADERS ---
    let headerRow1 = "<tr><th></th>";
    allDates.forEach(d => headerRow1 += `<th colspan='2'>${d}</th>`);
    headerRow1 += "</tr>";

    let headerRow2 = "<tr><th>EMPLOYEE NAME</th>";
    allDates.forEach(() => (headerRow2 += "<th>IN</th><th>OUT</th>"));
    headerRow2 += "</tr>";

    tableBody.innerHTML += headerRow1 + headerRow2;

    // --- EMPLOYEE ROWS ---
    const empNames = Object.keys(areaEmployees);
    if (empNames.length === 0) {
      const emptyRow = `<tr><td colspan="${1 + allDates.length * 2}" style="text-align:center;">No employees found</td></tr>`;
      tableBody.innerHTML += emptyRow;
    } else {
      empNames.forEach(empName => {
        let rowHtml = `<tr><td class="nameCell">${empName}</td>`;
        allDates.forEach(d => {
          const log = areaEmployees[empName]?.[d];
          rowHtml += `<td>${log ? formatTime(log.timeIn) : "-"}</td>`;
          rowHtml += `<td>${log ? formatTime(log.timeOut) : "-"}</td>`;
        });
        rowHtml += "</tr>";
        tableBody.innerHTML += rowHtml;
      });
    }

    // --- Spacer between areas ---
    tableBody.innerHTML += `<tr><td colspan="${1 + allDates.length * 2}" style="height:8px;"></td></tr>`;
  });

  // ‚úÖ Sticky first column setup
  const nameCells = table.querySelectorAll("th:first-child, td.nameCell");
  nameCells.forEach(cell => {
    cell.style.position = "sticky";
    cell.style.left = "0";
    cell.style.background = "#f9f9f9";
    cell.style.zIndex = "3";
    cell.style.textAlign = "left";
    cell.style.fontWeight = "600";
    cell.style.whiteSpace = "nowrap";
  });
}

// ‚úÖ Helper to format time
function formatTime(timeStr) {
  if (!timeStr) return "-";
  const d = new Date(timeStr);
  if (isNaN(d.getTime())) return "-";
  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2, "0");
  const suffix = hours >= 12 ? "PM" : "AM";
  hours = hours % 12 || 12;
  return `${hours}:${minutes}`;
}

async function loadTimeInArea() {
  const start = document.getElementById("timeinStart").value;
  const end = document.getElementById("timeinEnd").value;
  
  document.getElementById("dateRangeLabel").textContent = `${start} - ${end}`;

  try {
    const res = await fetch(
      `https://script.google.com/macros/s/AKfycbzxIw4N1eMDOvvyX_NqgBxW1NrzwSo-bvz6xn9Fw2nhmZPiXreP0RfZU9HsTK0Ezk0SlQ/exec?action=getTimeLogs&start=${start}&end=${end}`
    );
    const data = await res.json();

    console.log("Logs response:", data); // üü¢ DEBUG

    if (!Array.isArray(data)) {
      document.getElementById("tab4Body").innerHTML =
        "<tr><td colspan='4'>No valid data found</td></tr>";
      return;
    }

    // Render table initially with all data
    renderTimeInOutReport(data);

  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("tab4Body").innerHTML =
      "<tr><td colspan='4'>Error loading data</td></tr>";
  }
}

async function loadDynamicTimeInReport() {
  const start = document.getElementById("tab5Start").value;
  const end = document.getElementById("tab5End").value;
  const tbody = document.getElementById("tab5Body");
  const dateRangeLabel = document.getElementById("tab5DateRange");

  tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

  // üóìÔ∏è Update label
  if (start && end) {
    dateRangeLabel.textContent = `${start} to ${end}`;
  } else {
    dateRangeLabel.textContent = "All Dates";
  }

  try {
    // ‚õΩ Fetch logs (replace with your actual endpoint or Supabase query)
    const res = await fetch("https://your-backend-endpoint/api/logs");
    const logs = await res.json();

    // Filter by date range kung may filter
    const filteredLogs = logs.filter(log => {
      if (!start || !end) return true;
      const date = new Date(log.date);
      return date >= new Date(start) && date <= new Date(end);
    });

    renderTab5DynamicReport(filteredLogs);
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan='4' style="color:red;">Error loading data</td></tr>`;
    console.error(err);
  }
}

// ‚úÖ Expose globally so onclick works
window.loadTimeInArea = loadTimeInArea;
window.loadDynamicTimeInReport = loadDynamicTimeInReport;

}

</script>
</body>
</html>
