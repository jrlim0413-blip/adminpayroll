<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAYROLL SYSTEM</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/6SF5KQG.png">
<link rel="stylesheet" href="payroll-print.css">
<!-- CryptoJS for AES decryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style></style>
</head>
<body>
<header>
  Payroll System
  <button id="logoutBtn">Logout</button>
  <button id="themeToggle">Dark Mode</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="logs">Attendance Logs</div>
  <div class="tab" data-tab="tab2">Employee Deductions</div>
  <div class="tab" data-tab="tab3">Printing Section</div>
</div>

<div class="tab-content active" id="logs">
  <div class="filters">
    <select id="areaFilter"><option value="">All Areas</option></select>
    <input type="month" id="monthFilter">
    <input type="text" id="searchName" placeholder="Search by Name...">
    <button onclick="loadLogs()">Search</button>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>NAME</th><th>AREA</th><th>TIME IN</th><th>TIME OUT</th><th>DATE</th></tr>
      </thead>
      <tbody id="logsTable"><tr><td colspan='5'>Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div class="tab-content" id="tab2">
  <div class="filters">
    <span style="font-size: 24px; cursor: pointer;">üîç</span>
    <input type="text" id="rateSearch" placeholder="Search employee...">
    <button id="scanQRBtn" class="btn btn-success">üì∑ Scan QR to Add Employee</button>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>EMPLOYEE ID</th><th>NAME</th><th>AREA</th><th>DESIGNATION</th><th>MONTHLY SALARY</th><th>ACTION</th>
        </tr>
      </thead>
      <tbody id="ratesTable"><tr><td colspan='6'>Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="qrModal" class="modal">
  <div class="modal-content">
    <span id="closeQrModal" class="close-btn">&times;</span>
    <h2 class="modal-title">Scan QR Code</h2>
      <div class="qr-section">
        <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"type="text" id="qrInput" placeholder="Scan QR code...."autofocus>
      </div>
      
    <div class="modal-body">
      <div class="info-fields">
        <input  type="text" id="empID" placeholder="Employee ID" disabled>
        <input  type="text" id="empName" placeholder="Employee Name" disabled>
        <input  type="text" id="empArea" placeholder="Area" disabled>
      </div>

      <div class="edit-section">
        
        <label class="switch">
          <input type="checkbox" id="toggleEditBtn">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Edit</span>


        <input type="text" id="empDesignation" placeholder="Designation" disabled>
        <input type="text" id="empSalary" placeholder="Monthly Salary" disabled>
      </div>

      <button id="submitQRBtn" class="submit-btn">Add Employee</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="updateModal" class="modal" >
  <div class="modal-content">
    <div class="modal-header">
      <h2>Update Employee Information</h2>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>

    <div class="tabsmodal">
      <div class="modal-tab active" data-tab="employee">Employee Information</div>
      <div class="modal-tab" data-tab="tab2modal">Mandatory Deductions</div>
      <div class="modal-tab" data-tab="tab3modal">Voluntary Deductions</div>
      <div class="modal-tab" data-tab="tab4modal">Attendance-Based Deductions</div>
    </div>

    <div class="modal-tab-content active" id="employee">
      <div class="input-group" >
        <label for="empNameUp">Name</label>
        <input type="text" id="empNameUp"  readonly>
      </div>
         <div class="empInfo">
          <div class="input-group">
            <label for="empIDUp">Employment Information</label>
            <input type="text" id="empIDUp"  readonly>
            <input type="text" id="empAreaUp"  readonly>
          </div>
          <div class="input-group" id="desSal">
            <input type="text" id="empDesignationUp" disabled>
            <input type="number" id="empSalaryUp"  disabled>
            <button class="toggle-btn">Edit</button>
          </div>
         </div>
    </div>

    <div style="padding: 16px 24px; text-align: right;">
      <button class="btn" id="saveUpdateBtn">Save</button>
    </div>
  </div>
</div>



<div class="tab-content" id="tab3">
  <div class="print-controls">
    <label>Date Covered: <input type="date" id="dateStart"> - <input type="date" id="dateEnd"></label>
    <button onclick="window.print()">üñ® Print</button>
    <button onclick="downloadExcel()">‚¨á Download Excel</button>
  </div>
      <h3 style="text-align:center;margin:0;">SIMPAL GROUP OF COMPANIES</h3>
      <p style="text-align:center;margin:0;">ADMIN OFFICE</p>
      <p style="text-align:center;margin:0;">SALARY AND COMPENSATION</p>
      <p style="text-align:center;margin:0;">DATE COVERED: </p>

  <div class="table-container">
    <table id="tab3Table" border="1">
      <thead>
        <tr>
          <th>EMPLOYEE NAME</th>
          <th>DESIGNATION</th>
          <th>BASIC MONTHLY SALARY</th>
          <th>RATE PER DAY</th>
          <th>RATE PER HOUR</th>
          <th># OF DAYS</th>
          <th>TOTAL BASIC PAY</th>
          <th>ALLOWANCE</th>
          <th>RESTDAY</th>
          <th>OVERTIME</th>
          <th>PHIC</th>
          <th>HDMF</th>
          <th>SSS</th>
          <th>SALARY ADVANCEMENT</th>
          <th>LATE/UNDERTIME</th>
          <th>NET PAY</th>
          <th>SIGNATURE</th>
        </tr>
      </thead>
      <tbody id="tab3Body"><tr><td colspan="17">Loading...</td></tr></tbody>
       <tfoot>
        <tr id="totalRow" style="background:yellow;font-weight:bold">
          <td colspan="1">TOTAL</td>
          <td></td> <!-- Basic Salary -->
          <td></td> <!-- Rate/Day -->
          <td></td> <!-- Rate/Hour -->
          <td></td> <!-- Days -->
          <td></td> <!-- Total Basic Pay -->
          <td></td> <!-- Allowance -->
          <td></td> <!-- Restday -->
          <td></td> <!-- Overtime -->
          <td></td> <!-- PHIC -->
          <td></td> <!-- HDMF -->
          <td></td> <!-- SSS -->
          <td></td> <!-- Salary Adv -->
          <td></td> <!-- Late -->
          <td></td> <!-- Net Pay -->
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>


<!-- Signatories -->
<div style="margin-left:500px; display:flex; justify-content:space-between; width:100%;">
  <div style="text-align:center;">
    <p>Prepared by:</p>
    <p><u>QUENNIE R. CAPUYAN</u><br>HR Admin Payroll</p>
  </div>
  <div style="text-align:center; margin-right:1000px;" >
    <p>Reviewed & Released by:</p>
    <p><u>JEVINCE JAYE S. JUBAY</u><br>HRMD Manager</p>
  </div>
</div>

 



<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzxIw4N1eMDOvvyX_NqgBxW1NrzwSo-bvz6xn9Fw2nhmZPiXreP0RfZU9HsTK0Ezk0SlQ/exec"; // Palitan ng actual URL
const SECRET_KEY = "jayryan"; // Secret key for AES

if (!sessionStorage.getItem("loggedIn")) window.location.replace("login.html");

document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.clear();
  window.location.replace("login.html");
});

window.history.pushState(null,"",window.location.href);
window.addEventListener("popstate",()=>{if(!sessionStorage.getItem("loggedIn"))window.location.replace("login.html");else window.history.pushState(null,"",window.location.href);});

const toggleBtn = document.getElementById('themeToggle');
let darkMode=false;
toggleBtn.addEventListener('click',()=>{
  darkMode=!darkMode;
  if(darkMode){
    document.documentElement.style.setProperty('--bg-color','#1c1c1e');
    document.documentElement.style.setProperty('--text-color','#f2f2f7');
    document.documentElement.style.setProperty('--card-bg','#2c2c2e');
    document.documentElement.style.setProperty('--border-color','#3a3a3c');
    document.documentElement.style.setProperty('--tab-active','#0a84ff');
    toggleBtn.textContent='Light Mode';
  }else{
    document.documentElement.style.setProperty('--bg-color','#f2f2f7');
    document.documentElement.style.setProperty('--text-color','#1c1c1e');
    document.documentElement.style.setProperty('--card-bg','#fff');
    document.documentElement.style.setProperty('--border-color','#d1d1d6');
    document.documentElement.style.setProperty('--tab-active','#007aff');
    toggleBtn.textContent='Dark Mode';
  }
});

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
    if(tab.dataset.tab==="tab2") loadRates();
    if(tab.dataset.tab==="tab3") loadTab3Data();
  });
});

document.querySelectorAll('#updateModal .modal-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const parent = tab.closest('.modal');

    // Remove active class sa lahat ng modal tabs at contents
    parent.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    parent.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));

    // Add active sa clicked tab at corresponding content
    tab.classList.add('active');
    const tabId = tab.dataset.tab;
    parent.querySelector(`#${tabId}`).classList.add('active');
  });
});


async function loadLogs(){
  const area=document.getElementById("areaFilter").value;
  const monthInput=document.getElementById("monthFilter");
  if(!monthInput.value){const today=new Date();monthInput.value=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}`;}
  const month=monthInput.value;
  const search=document.getElementById("searchName").value.trim();
  const tbody=document.getElementById("logsTable");
  tbody.innerHTML="<tr><td colspan='5'>Loading...</td></tr>";
  try{
    const res=await fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({action:"getLogs",area:area,month:month,search:search})});
    const data=await res.json();
    if(!data||data.length===0){tbody.innerHTML="<tr><td colspan='5'>No logs found</td></tr>";return;}
    data.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const uniqueAreas=[...new Set(data.map(r=>r.area).filter(a=>a))];
    const areaFilter=document.getElementById("areaFilter");areaFilter.innerHTML='<option value="">All Areas</option>';uniqueAreas.forEach(a=>{const opt=document.createElement("option");opt.value=a;opt.textContent=a;areaFilter.appendChild(opt);});
    tbody.innerHTML="";
    data.forEach(log=>{
      const row=`<tr>
        <td>${log.name?log.name.toUpperCase():"UNKNOWN"}</td>
        <td>${log.area?log.area.toUpperCase():"-"}</td>
        <td>${formatTimeCell(log.timeIn)}</td>
        <td>${formatTimeCell(log.timeOut)}</td>
        <td>${log.date}</td>
      </tr>`;tbody.insertAdjacentHTML("beforeend",row);
    });
  }catch(err){console.error(err);tbody.innerHTML="<tr><td colspan='5'>Error loading logs</td></tr>";}
}
function formatTimeCell(value){if(!value)return"-";const date=new Date(value);if(isNaN(date))return value;let h=date.getHours();const m=String(date.getMinutes()).padStart(2,'0');const ampm=h>=12?"PM":"AM";h=h%12;h=h===0?12:h;return`${h}:${m} ${ampm}`;}
document.addEventListener("DOMContentLoaded",loadLogs);

// --- Employee Deductions ---
window.employeeRates=[];
async function loadRates(){
  const tbody=document.getElementById("ratesTable");
  tbody.innerHTML="<tr><td colspan='6'>Loading...</td></tr>";
  try{
    const res=await fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({action:"getRates"})});
    const data=await res.json();
    
    if(!data||data.length===0){tbody.innerHTML="<tr><td colspan='6'>No rates found</td></tr>";return;}
    
    window.employeeRates = data.map(emp => ({
      id: emp.id || "",
      name: emp.employeeName || "UNKNOWN",
      area: emp.area || "-",
      designation: emp.designation || "-",
      monthlySalary: emp.basicmonthlySalary ? Number(emp.basicmonthlySalary).toFixed(2) : "0.00",
      mandatoryDeduction: emp.mandatoryDeduction || "",
      applyMandatoryAll: emp.applyMandatoryAll || false,
      voluntaryDeduction: emp.voluntaryDeduction || "",
      voluntaryStart: emp.voluntaryStart || "",
      voluntaryEnd: emp.voluntaryEnd || "",
      attendanceDeduction: emp.attendanceDeduction || ""
    }));

    renderRates(window.employeeRates);
  }catch(err){console.error(err);tbody.innerHTML="<tr><td colspan='6'>Error loading rates</td></tr>";}
}

function renderRates(rates){
  const tbody=document.getElementById("ratesTable");tbody.innerHTML="";
  if(rates.length===0){tbody.innerHTML="<tr><td colspan='6'>No matching employees</td></tr>";return;}
  rates.forEach(emp=>{
    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${emp.id}</td>
      <td>${emp.name}</td>
      <td>${emp.area}</td>
      <td>${emp.designation}</td>
      <td>‚Ç±${emp.monthlySalary}</td>
      <td>
        <button class="update-btn"  onclick='openUpdateEmployeeModal(${JSON.stringify(emp)})'>‚úèÔ∏è Update Information</button>

    `;
    tbody.appendChild(row);
    const btn = row.querySelector(".update-btn");
    btn.addEventListener("click", () => openUpdateEmployeeModal(emp));
  });
}



function openUpdateEmployeeModalById(btn) {
  const empId = btn.dataset.id;
  const emp = window.employeeRates.find(e => e.id === empId);
  if(!emp) return alert("Employee not found");
  openUpdateEmployeeModal(emp);
}


document.getElementById("rateSearch").addEventListener("input",()=>{
  const search=document.getElementById("rateSearch").value.toLowerCase();
  const filtered=window.employeeRates.filter(emp=>emp.name.toLowerCase().includes(search));
  renderRates(filtered);
});



// ---------------- Tab3: Payroll Printing ----------------
async function loadTab3Data(){
  const tbody=document.getElementById("tab3Body");
  tbody.innerHTML="<tr><td colspan='17'>Loading...</td></tr>";
  try{
    const res=await fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({action:"getRates"})});
    const data=await res.json();
    if(!data||data.length===0){tbody.innerHTML="<tr><td colspan='17'>No data found</td></tr>";return;}
    tbody.innerHTML="";
    data.forEach(emp=>{
      const days=30; // placeholder # of days
      const ratePerDay=(emp.basicmonthlySalary/30).toFixed(2);
      const ratePerHour=(ratePerDay/8).toFixed(2);
      const totalBasicPay=emp.basicmonthlySalary.toFixed(2);
      const allowance=emp.allowance||0;
      const restday=0,overtime=0,phic=0,hdmf=0,sss=0,salaryAdv=0,late=0;
      const netPay=(parseFloat(totalBasicPay)+parseFloat(allowance)-phic-hdmf-sss-salaryAdv-late).toFixed(2);

      const row=`<tr>
        <td>${emp.employeeName}</td>
        <td>${emp.designation||""}</td>
        <td>${Number(emp.basicmonthlySalary).toLocaleString()}</td>
        <td>${Number(ratePerDay).toLocaleString()}</td>
        <td>${ratePerHour}</td>
        <td>${days}</td>
        <td>${Number(totalBasicPay).toLocaleString()}</td>
        <td>${allowance}</td>
        <td>${restday}</td>
        <td>${overtime}</td>
        <td>${phic}</td>
        <td>${hdmf}</td>
        <td>${sss}</td>
        <td>${salaryAdv}</td>
        <td>${late}</td>
        <td>${Number(netPay).toLocaleString()}</td>
        <td></td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend",row);
    });
    computeTotals();
  }catch(err){console.error(err); tbody.innerHTML="<tr><td colspan='17'>Error loading data</td></tr>";}
}

// ---------------- Download Excel ----------------
function downloadExcel(){
  const table = document.getElementById("tab3Table").outerHTML;
  const html=`<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body>${table}</body></html>`;
  const blob=new Blob([html],{type:"application/vnd.ms-excel"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="payroll_tab3.xls";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
function computeTotals(){
  const tbody = document.getElementById("tab3Body");
  const rows = tbody.querySelectorAll("tr");
  const totalRow = document.getElementById("totalRow");
  const totalCells = totalRow.querySelectorAll("td");

  // initialize totals per column
  let totals = Array(totalCells.length).fill(0);

  rows.forEach(row=>{
    const cells = row.querySelectorAll("td");
    cells.forEach((cell,i)=>{
      let val = cell.textContent.replace(/,/g,"").trim(); 
      if(!isNaN(val) && val !== "" && i >= 2 && i <= 15){ 
        totals[i] += parseFloat(val);
      }
    });
  });

  // apply totals
  totals.forEach((t,i)=>{
    if(i >= 2 && i <= 15){
      totalCells[i].textContent = t.toLocaleString(undefined,{
        minimumFractionDigits:0,
        maximumFractionDigits:2
      });
    }
  });
}
// --- QR Modal ---
const qrModal = document.getElementById("qrModal");
const openQrBtn = document.getElementById("scanQRBtn");
const closeQrBtn = document.getElementById("closeQrModal");
const qrInput = document.getElementById("qrInput");

// Track last scanned QR ID to prevent duplicates
let lastScanId = null;

openQrBtn.addEventListener("click", () => {
  qrModal.classList.add("show");
  qrInput.value = "";
  qrInput.focus();
});

closeQrBtn.addEventListener("click", () => {
  qrModal.classList.remove("show");

   // Clear all modal inputs
  document.getElementById("qrInput").value = "";
  document.getElementById("empID").value = "";
  document.getElementById("empName").value = "";
  document.getElementById("empArea").value = "";
  empDesignation.value = "";
  empSalary.value = "";

  // Reset toggle and disable fields
  empDesignation.disabled = true;
  empSalary.disabled = true;
  toggleEditBtn.textContent = "Edit Details";
});

window.addEventListener("click", e => { if(e.target===qrModal) qrModal.classList.remove("show"); });

// --- Function to open modals dynamically ---
function openModal(modalId){
  document.getElementById(modalId).classList.add("show");
}
function closeModal(modalId){

  const modal = document.getElementById(modalId);modal.classList.remove("show");

  const inputs = modal.querySelectorAll("input");
  inputs.forEach(input => input.value = "");
}

// --- Toggle Designation & Salary ---
const toggleEditBtn = document.getElementById("toggleEditBtn");
const empDesignation = document.getElementById("empDesignation");
const empSalary = document.getElementById("empSalary");

toggleEditBtn.addEventListener("click", () => {
  const editable = empDesignation.disabled; // true if currently disabled
  empDesignation.disabled = !editable;
  empSalary.disabled = !editable;
  empDesignation.style.backgroundColor = editable ? "#fff" : "#f0f0f0";
  empSalary.style.backgroundColor = editable ? "#fff" : "#f0f0f0";
  toggleEditBtn.textContent = editable ? "Lock Details" : "Edit Details";
});

// --- Pending Employees after QR scan ---
window.pendingEmployees = [];


// Render pending employees table
function renderPendingEmployees(){
  const tbody = document.getElementById("ratesTable");
  tbody.innerHTML = "";

  if(window.pendingEmployees.length === 0){
    tbody.innerHTML = "<tr><td colspan='6'>No employees scanned</td></tr>";
    return;
  }

  window.pendingEmployees.forEach(emp => {
    const row = document.createElement("tr");

    // Highlight if designation or salary is blank
    let highlightClass = "";
    if(!emp.designation || !emp.salary) highlightClass = "incomplete";

    row.innerHTML = `
      <td class="${highlightClass}">${emp.id}</td>
      <td class="${highlightClass}">${emp.name}</td>
      <td class="${highlightClass}">${emp.area}</td>
      <td class="${highlightClass}">${emp.designation || "-"}</td>
      <td class="${highlightClass}">${emp.salary ? "‚Ç±" + Number(emp.salary).toFixed(2) : "-"}</td>
      <td>
        <button onclick='editPendingEmployee("${emp.id}")'>‚úèÔ∏è Update</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Edit employee from pending table
function editPendingEmployee(empId){
  const emp = window.pendingEmployees.find(e => e.id === empId);
  if(!emp) return alert("Employee not found");

  // Fill modal
  document.getElementById("empID").value = emp.id;
  document.getElementById("empName").value = emp.name;
  document.getElementById("empArea").value = emp.area;
  empDesignation.value = emp.designation || "";
  empSalary.value = emp.salary || "";

  // Enable editing
  empDesignation.disabled = false;
  empSalary.disabled = false;
  empDesignation.style.backgroundColor = "#fff";
  empSalary.style.backgroundColor = "#fff";
  toggleEditBtn.textContent = "Lock Details";

  // Remove from pending array (will re-add on submit)
  window.pendingEmployees = window.pendingEmployees.filter(e => e.id !== empId);
  renderPendingEmployees();

  qrModal.classList.add("show");
}

// Add CSS for incomplete highlight dynamically (optional if not in CSS file)
const style = document.createElement('style');
style.textContent = `
  .incomplete {
    background-color: #fff3cd;
    font-weight: bold;
  }
`;
document.head.appendChild(style);

function decryptQR(encrypted) {
  try {
    const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8);

    if (!decrypted) {
      console.error("‚ö†Ô∏è Empty decrypted text - possible wrong key or corrupted QR.");
      return null;
    }

    return JSON.parse(decrypted);
  } catch (err) {   
    console.error("Decryption error:", err);
    return null;
  }
}

// --- Prevent bad paste characters ---
qrInput.addEventListener("paste", (e) => {
  e.preventDefault();
  let paste = (e.clipboardData || window.clipboardData).getData('text');
  paste = paste.trim().replace(/[\r\n\t]+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '');
  qrInput.value = paste;
});

// --- QR input handling ---
qrInput.addEventListener("keydown", (e) => {
  if (e.key !== "Enter") return;
  e.preventDefault();

  let qrData = qrInput.value.trim().replace(/[\r\n\t]+/g, '');
  if(!qrData) return;

  let data;
  try {
    data = decryptQR(qrData);
    if(!data) throw new Error("Invalid QR");
  } catch(err) {
    alert("Invalid or corrupted QR code!");
    qrInput.value = "";
    return;
  }

  // Prevent same QR from being scanned repeatedly
  if(data.id === lastScanId) {
    alert("‚ö†Ô∏è This QR has already been scanned!");
    qrInput.value = "";
    return;
  }
  lastScanId = data.id;

  // Auto-fill inputs
  document.getElementById("empID").value = data.id || "";
  document.getElementById("empName").value = data.name || "";
  document.getElementById("empArea").value = data.area || "";
  empDesignation.value = data.designation || "";
  empSalary.value = data.salary || "";
  empDesignation.disabled = true;
  empSalary.disabled = true;
  toggleEditBtn.textContent = "Edit Details";

  qrInput.value = "";

  // Optional auto-clear modal fields after 10 seconds (non-intrusive)
  setTimeout(() => {
    if(qrModal.classList.contains("show")) return; // do not clear if modal still open
    document.getElementById("empID").value = "";
    document.getElementById("empName").value = "";
    document.getElementById("empArea").value = "";
    empDesignation.value = "";
    empSalary.value = "";
  }, 10000);
});
// --- Add Employee to Google Sheet ---
document.getElementById("submitQRBtn").addEventListener("click", async () => {
  const id = document.getElementById("empID").value.trim();
  const name = document.getElementById("empName").value.trim();
  const area = document.getElementById("empArea").value.trim();
  const designation = empDesignation.value.trim();
  const salary = empSalary.value.trim();

  if (!id || !name || !area) {
    alert("‚ö†Ô∏è Employee ID, Name, and Area are required!");
    return;
  }

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "addEmployee",
        id,
        name,
        area,
        designation,
        salary
      })
    });

    const result = await res.json();
    console.log("Backend response:", result);
    if (result.success) {
      alert("‚úÖ Employee added successfully!");

      // refresh rates table
      loadRates();

      // close modal
      qrModal.classList.remove("show");

      // clear fields
      document.getElementById("empID").value = "";
      document.getElementById("empName").value = "";
      document.getElementById("empArea").value = "";
      empDesignation.value = "";
      empSalary.value = "";
    } else {
      alert(result.message || "‚ùå Failed to add employee!");
    }
  } catch (err) {
    console.error("Add Employee error:", err);
    alert("‚ö†Ô∏è Error saving employee!");
  }
});


function openUpdateEmployeeModal(emp) {
   console.log("EMP object received:", emp);
  // Fill fields
  document.getElementById("empNameUp").value = emp.name || "";
  document.getElementById("empIDUp").value = emp.id || "";
  document.getElementById("empAreaUp").value = emp.area || "";
  document.getElementById("empDesignationUp").value = emp.designation || "";
  document.getElementById("empSalaryUp").value = emp.monthlySalary || "";

  // Enable editing if you want
  document.getElementById("empDesignationUp").disabled = false;
  document.getElementById("empSalaryUp").disabled = false;

  // Show modal
  document.getElementById("updateModal").classList.add("show");
}

document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("updateModal").classList.remove("show");

  // Optional: clear all fields
  const inputs = document.getElementById("updateModal").querySelectorAll("input");
  inputs.forEach(i => i.value = "");
});

  
// --- Save Update Button ---
document.getElementById("saveUpdateBtn").addEventListener("click", async () => {
  const id = document.getElementById("empIDUp").value.trim();
  const designation = document.getElementById("empDesignationUp").value.trim();
  const salary = document.getElementById("empSalaryUp").value.trim();

  if (!id || !designation || !salary) {
    alert("‚ö†Ô∏è Please fill in all fields!");
    return;
  }

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "updateEmployee",
        id,
        designation,
        salary
      })
    });

    const result = await res.text();
    console.log("Update response:", result);

    if (result === "OK") {
      alert("‚úÖ Employee updated successfully!");
      document.getElementById("updateModal").classList.remove("show");
      loadRates(); // refresh table
    } else if (result === "NOT_FOUND") {
      alert("‚ùå Employee not found!");
    } else {
      alert("‚ö†Ô∏è Error updating employee!");
    }
  } catch (err) {
    console.error("Update error:", err);
    alert("‚ùå Network error, please try again!");
  }
});

document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("deleteBtn")) {
    const empId = e.target.dataset.id;
    if (!confirm("Are you sure you want to delete this employee?")) return;

    try {
      const res = await fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({
          action: "deleteEmployee",
          id: empId
        })
      });
      const result = await res.json();
      alert(result.message);

      if (result.success) {
        // refresh the employee list
        loadRates();
      }
    } catch (err) {
      alert("‚ùå Error deleting employee: " + err.message);
    }
  }
});

</script>

</body>
</html>
