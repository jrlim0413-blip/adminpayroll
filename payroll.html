<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAYROLL SYSTEM</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/6SF5KQG.png">
<link rel="stylesheet" type="text/css" href="payroll-print.css">
<!-- CryptoJS for AES decryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
 


</style>
</head>
<body>
<div class="payroll-modal-overlay" id="payrollModalOverlay">
    <div class="payroll-modal" id="payrollModalBox">
      <div class="payroll-modal-header">Payroll Settings</div>
      <div class="payroll-modal-body">
        <table>
          <thead>
            <tr>
              <th rowspan="2">Area</th>
              <th colspan="2">Rates</th>
              <th colspan="3">Cut-Off</th>
            </tr>
            <tr>
              <th>Fixed Rate</th>
              <th>Daily Rate</th>
              <th>Monthly</th>
              <th>Semi Monthly</th>
              <th>Weekly</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ADMIN</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>AWANG</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>SOUTH UPI</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>NORTH UPI</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>PARANG</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>COTABATO</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>ILIGAN</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>WAO</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>LALA</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>BALOI</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>MARAWI</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>MALABANG</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>BALAGAN</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>
            <tr>
              <td>SET B ILIGAN</td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
              <td><input type="checkbox"></td>
            </tr>

          </tbody>
        </table>
      </div>
      <div class="payroll-modal-footer">
        <button class="payroll-btn payroll-btn-close" onclick="closePayrollModal()">Cancel</button>
        <button class="payroll-btn payroll-btn-primary" onclick="savePayrollSettings()">Save</button>
      </div>
    </div>
  </div>
 

  
<header class="ios-header">
  <div class="ios-logo">
    <img src="https://i.imgur.com/6SF5KQG.png" alt="Logo">
    <span class="app-name">Payroll System</span>
  </div>

  <div class="ios-right">
    <div class="ios-tabs">
      <!-- Only Attendance Logs is a main tab -->
      <div class="ios-tab ios-tab--simple tab" data-tab="logs" data-target="logs">Attendance Logs</div>

      <!-- Adjustments dropdown -->
      <div class="ios-tab ios-tab--dropdown" data-dropdown="adjustmentsMenu">
        Adjustments <span class="chev">‚ñæ</span>
        <div class="ios-dropdown" id="adjustmentsMenu">
          <a href="#" data-target="tab2">Addition & Deduction</a>
          <a href="#" data-target="tabY">Exempted</a>
        </div>
      </div>

      <!-- Reports dropdown -->
      <div class="ios-tab ios-tab--dropdown" data-dropdown="reportsMenu">
        Reports <span class="chev">‚ñæ</span>
        <div class="ios-dropdown" id="reportsMenu">
          <a href="#" data-target="tab3">Payroll</a>
          <a href="#" data-target="tab4">Time In / Time Out</a>
          <a href="#" data-target="tab5">13th Month Pay</a>
        </div>
      </div>
  </div>
    </div>

    <!-- Settings -->
    <div class="settings-dropdown">
      <button class="settings-btn">‚öôÔ∏è</button>
      <div class="settings-menu">
        <h3 class="title">Settings</h3>
        <button onclick="openPayrollModal()">Payroll Settings</button>
        <button id="themeToggle">Dark Mode</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>


</header>


<div class="tab-content active" id="logs">
  <div class="filters">
    <select id="areaFilter"><option value="">All Areas</option></select>
    <input type="month" id="monthFilter">
    <input type="text" id="searchName" placeholder="Search by Name...">
    <button onclick="loadLogs()">Search</button>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>NAME</th><th>AREA</th><th>TIME IN</th><th>TIME OUT</th><th>DATE</th></tr>
      </thead>
      <tbody id="logsTable"><tr><td colspan='5'>Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div class="tab-content" id="tab2">
  <div class="filters">
    <span style="font-size: 24px; cursor: pointer;">üîç</span>
    <input type="text" id="rateSearch" placeholder="Search employee...">
    <button id="scanQRBtn" class="btn btn-success">üì∑ Scan QR to Add Employee</button>
  </div>
  <div class="table-container">
    <table id="myTable">
      <thead>
        <tr>
          <th>EMPLOYEE ID</th><th>NAME</th><th>AREA</th><th>DESIGNATION</th><th>MONTHLY SALARY</th><th>ACTION</th>
        </tr>
      </thead>
      <tbody id="ratesTable"><tr><td colspan='6'>Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="qrModal" class="modal">
  <div class="modal-content">
    <span id="closeQrModal" class="close-btn">&times;</span>
    <h2 class="modal-title">Scan QR Code</h2>
      <div class="qr-section">
        <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"type="text" id="qrInput" placeholder="Scan QR code...."autofocus>
      </div>
      
    <div class="modal-body">
      <div class="info-fields">
        <input  type="text" id="empID" placeholder="Employee ID" disabled>
        <input  type="text" id="empName" placeholder="Employee Name" disabled>
        <input  type="text" id="empArea" placeholder="Area" disabled>
      </div>

      <div class="edit-section">
        
        <label class="switch">
          <input type="checkbox" id="toggleEditBtnAdd">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Edit</span>


        <input type="text" id="empDesignation" placeholder="Designation" disabled>
        <input type="text" id="empSalary" placeholder="Monthly Salary" disabled>
      </div>

      <button id="submitQRBtn" class="submit-btn">Add Employee</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="updateModal" class="modal" >
  <div class="modal-content">
    <div class="modal-header">
      <h2>Update Employee Information</h2>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>

    <div class="tabsmodal">
      <div class="modal-tab active" data-tab="employee">Employee Information</div>
      <div class="modal-tab" data-tab="tab2modal">Mandatory Deductions</div>
      <div class="modal-tab" data-tab="tab3modal">Voluntary Deductions</div>
      <div class="modal-tab" data-tab="tab4modal">Attendance-Based Deductions</div>
    </div>

        <div class="modal-tab-content active" id="employee">
          <div class="input-group">
            <label for="empNameUp">Name</label>
            <input type="text" id="empNameUp" readonly>
          </div>
          <div class="empInfo">
            <div class="input-group">
              <label for="empIDUp">Employment Information</label>
              <input type="text" id="empIDUp" readonly>
              <input type="text" id="empAreaUp" readonly>
            </div>

            <div class="input-group" id="desSal">
              <input type="text" id="empDesignationUp" placeholder="Designation" disabled>
              <input type="number" id="empSalaryUp" placeholder="Salary" disabled>
              <!-- Toggle button -->
              <label class="switch">
                <input type="checkbox" id="toggleEditUpdate">
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>




       <div class="modal-tab-content" id="tab2modal">

        <div class="deduction-row">
          <p class="note">
            <b>SSS Computation Rule (2025):</b><br>
            - Monthly Salary Credit (MSC) = Salary rounded to nearest bracket (‚Ç±4,000 min, ‚Ç±30,000 max)<br>
            - Total Contribution = MSC √ó 15%<br>
            - Employee Share = MSC √ó 4.5%<br>
            - Employer Share = MSC √ó 8.5% + EC (‚Ç±10‚Äì‚Ç±30)
          </p>
          <div class="input-group">
            <label for="sssDeduction">SSS</label>
            <input type="number" id="sssDeduction" placeholder="MSC √ó 15%" disabled>
                <label class="switch">
                    <input type="checkbox" id="toggleSSS">
                    <span class="slider"></span>
                </label>
          </div>
        </div>

        <div class="deduction-row">
          <p class="note">
            <b>PhilHealth Computation Rule (2025):</b><br>
            - Premium Rate = 5% of Monthly Salary<br>
            - Salary Floor = ‚Ç±10,000 | Salary Ceiling = ‚Ç±100,000<br>
            - Total Contribution = Salary √ó 5% (min ‚Ç±10,000, max ‚Ç±100,000)<br>
            - Employee Share = 50% of Total Contribution<br>
            - Employer Share = 50% of Total Contribution
          </p>
          <div class="input-group">
            <label for="phicDeduction">PhilHealth</label>
            <input type="number" id="phicDeduction" placeholder="5% of salary (‚Ç±10k‚Äì‚Ç±100k)" disabled>
                 <label class="switch">
                    <input type="checkbox" id="togglePHIC">
                    <span class="slider"></span>
                </label>
          </div>
        </div>

        <div class="deduction-row">
          <p class="note">
            <b>Pag-IBIG Contribution Rule:</b><br>
            - Salary Ceiling = ‚Ç±5,000<br>
            - Employee Share = 1% (‚â§ ‚Ç±1,500) or 2% (> ‚Ç±1,500)<br>
            - Employer Share = 2%<br>
            - Total = Employee + Employer
          </p>
          <div class="input-group">
            <label for="hdmfDeduction">Pag-IBIG</label>
            <input type="number" id="hdmfDeduction" placeholder="1%/2% + 2% (‚Ç±5k max)" disabled>
                  <label class="switch">
                    <input type="checkbox" id="toggleHDMF">
                    <span class="slider"></span>
                </label>
          </div>
        </div>

      </div>

      <div class="modal-tab-content" id="tab3modal">

          <div class="voluntary-row">
            <div class="input-group">
              <label for="volDeductionType">Deduction Type</label>
              <select id="volDeductionType" disabled>
                <option value="">-- Select Deduction --</option disabled>
                <option value="salaryLoan">Salary Loan</option>
                <option value="calamityLoan">Calamity Loan</option>
                <option value="cashAdvance">Cash Advance (CA)</option>
                <option value="other">Other Deduction</option>
              </select>
            </div>

            <div class="input-group">
              <label for="volDeductionAmount">Amount</label>
              <input type="number" id="volDeductionAmount" placeholder="0.00" disabled>
            </div>
          </div>

          <!-- Hidden by default: lalabas lang kung Cash Advance -->
          <div id="cashAdvanceOptions" class="cash-advance-box" style="display:none;">
            <label>
              <input type="checkbox" id="caInstallment"> Pay by Installment
            </label>

            <div class="ca-fields" style="display:none;">
              <div class="input-group">
                <label for="caTotal">Total Cash Advance</label>
                <input type="number" id="caTotal" placeholder="0.00">
              </div>

              <div class="input-group">
                <label for="caPerCutoff">Deduction per Cutoff (15/30)</label>
                <input type="number" id="caPerCutoff" placeholder="0.00">
                <!-- Result preview -->
                  <div id="caComputation" style="margin-top:8px; font-size:13px; color:#333;">
                  </div>
              </div>
            </div>
          </div>

          <div class="deduction-toggle">
            <label class="switch">
              <input type="checkbox" id="voluntaryToggle">
              <span class="slider"></span>
            </label>
            <span class="toggle-label">Apply Voluntary Deductions</span>
          </div>
        </div>

       
                    <!-- Tab 4: Attendance-Based Deduction -->
            <div class="modal-tab-content" id="tab4modal">
              <p class="note">
                <b>Rate & Deduction Computation:</b><br>
                - <strong>Rate per Day</strong> = Monthly Salary √∑ 26 (o 30)<br>
                - <strong>Rate per Hour</strong> = Rate per Day √∑ 8<br>
                - <strong>Rate per Minute</strong> = Rate per Hour √∑ 60<br>
                - <strong>Deduction</strong> = (# of lates in minutes √ó rate/minute) + (undertime √ó rate/minute) + (absences √ó rate/day)
              </p>

              <div class="input-group">
                <label for="dailyRate">Rate per Day</label>
                <input type="text" id="dailyRate" placeholder="Auto-calculated" disabled>
              </div>
              <div class="input-group">
                <label for="hourlyRate">Rate per Hour</label>
                <input type="text" id="hourlyRate" placeholder="Auto-calculated" disabled>
              </div>
              <div class="input-group">
                <label for="minuteRate">Rate per Minute</label>
                <input type="text" id="minuteRate" placeholder="Auto-calculated" disabled>
              </div>
              <div class="input-group">
                <label for="totalDeduction">Deduction</label>
                <input type="text" id="totalDeduction" placeholder="Auto-calculated" disabled>
              </div>
            </div>



       <div style="padding: 16px 24px; text-align: right;">
      <button class="btn" id="saveUpdateBtn">Save</button>
    </div>
  </div>
</div>





<div class="tab-content" id="tab3">
  <div class="print-controls">
    <label>Date Covered: <input type="date" id="dateStart"> - <input type="date" id="dateEnd"></label>
    <button onclick="window.print()">üñ® Print</button>
    <button onclick="downloadExcel()">‚¨á Download Excel</button>
  </div>
      <h3 style="text-align:center;margin:0;">SIMPAL GROUP OF COMPANIES</h3>
      <p style="text-align:center;margin:0;">ADMIN OFFICE</p>
      <p style="text-align:center;margin:0;">SALARY AND COMPENSATION</p>
      <p style="text-align:center;margin:0;">DATE COVERED: </p>

  <div class="table-container">
    <table id="tab3Table" border="1">
      <thead>
        <tr>
          <th>EMPLOYEE NAME</th>
          <th>DESIGNATION</th>
          <th>BASIC MONTHLY SALARY</th>
          <th>RATE PER DAY</th>
          <th>RATE PER HOUR</th>
          <th># OF DAYS</th>
          <th>TOTAL BASIC PAY</th>
          <th>ALLOWANCE</th>
          <th>RESTDAY</th>
          <th>OVERTIME</th>
          <th>PHIC</th>
          <th>HDMF</th>
          <th>SSS</th>
          <th>SALARY ADVANCEMENT</th>
          <th>LATE/UNDERTIME</th>
          <th>NET PAY</th>
          <th>SIGNATURE</th>
        </tr>
      </thead>
      <tbody id="tab3Body"><tr><td colspan="17">Loading...</td></tr></tbody>
       <tfoot>
        <tr id="totalRow" style="background:yellow;font-weight:bold">
          <td colspan="1">TOTAL</td>
          <td></td> <!-- Basic Salary -->
          <td></td> <!-- Rate/Day -->
          <td></td> <!-- Rate/Hour -->
          <td></td> <!-- Days -->
          <td></td> <!-- Total Basic Pay -->
          <td></td> <!-- Allowance -->
          <td></td> <!-- Restday -->
          <td></td> <!-- Overtime -->
          <td></td> <!-- PHIC -->
          <td></td> <!-- HDMF -->
          <td></td> <!-- SSS -->
          <td></td> <!-- Salary Adv -->
          <td></td> <!-- Late -->
          <td></td> <!-- Net Pay -->
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
<!-- Signatories -->
<div style="margin-left:500px; display:flex; justify-content:space-between; width:100%;">
  <div style="text-align:center;">
    <p>Prepared by:</p>
    <p><u>QUENNIE R. CAPUYAN</u><br>HR Admin Payroll</p>
  </div>
  <div style="text-align:center; margin-right:1000px;" >
    <p>Reviewed & Released by:</p>
    <p><u>JEVINCE JAYE S. JUBAY</u><br>HRMD Manager</p>
  </div>
</div>
</div>

<div class="tab-content" id="tab4">
  <div class="print-controls">
   <label>Date Covered: 
      <input type="date" id="timeinStart"> - 
      <input type="date" id="timeinEnd">
  </label>
   <label>Area: 
    <select id="areaFilter">
      <option value="">All Areas</option> <!-- default: show all -->
    </select>
  </label>

    <button onclick="loadTimeInArea()">üîç Apply Filter</button>
    <button onclick="window.print()">üñ® Print</button>
    <button onclick="downloadTimeInExcel()">‚¨á Download Excel</button>

  </div>

  <h3 style="text-align:center;margin:0;">SIMPAL GROUP OF COMPANIES</h3>
  <p style="text-align:center;margin:0;">TIME IN / TIME OUT REPORT</p>
  <p style="text-align:center;margin:0;">DATE COVERED: <span id="dateRangeLabel"></span></p>

  <div class="table-container">
    <table id="tab4Table" border="1">
      <!-- Dynamic header & body will be injected -->
      <thead id="tab4Head"></thead>
      <tbody id="tab4Body">
        <tr><td>Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

  

<script>
  function openPayrollModal() {
      document.getElementById("payrollModalOverlay").style.display = "flex";
      setTimeout(() => {
        document.getElementById("payrollModalBox").classList.add("show");
      }, 10);
    }

    function closePayrollModal() {
      const modal = document.getElementById("payrollModalBox");
      modal.classList.remove("show");
      setTimeout(() => {
        document.getElementById("payrollModalOverlay").style.display = "none";
      }, 300);
    }

   function savePayrollSettings() {
  const table = document.querySelector("#payrollModalBox tbody");
  const rows = table.querySelectorAll("tr");
  const data = [];

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    const area = cells[0].textContent.trim();
    const fixed = cells[1].querySelector("input").checked ? 1 : 0;
    const daily = cells[2].querySelector("input").checked ? 1 : 0;
    const monthly = cells[3].querySelector("input").checked ? 1 : 0;
    const semi = cells[4].querySelector("input").checked ? 1 : 0;
    const weekly = cells[5].querySelector("input").checked ? 1 : 0;

    data.push({ area, fixed, daily, monthly, semi, weekly });
  });

  fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `action=savePayrollSettings&data=${encodeURIComponent(JSON.stringify(data))}`
  })
    .then(res => res.text())
    .then(res => {
      alert("Payroll settings saved!");
      closePayrollModal();
    })
    .catch(err => console.error("Error saving payroll settings:", err));
}


    const settingsBtn = document.querySelector('.settings-btn');
    const settingsDropdown = document.querySelector('.settings-dropdown');

    settingsBtn.addEventListener('click', () => {
      settingsDropdown.classList.toggle('show');
    });

    // Close dropdown kapag nag-click sa labas
    window.addEventListener('click', (e) => {
      if (!e.target.closest('.settings-dropdown')) {
        settingsDropdown.classList.remove('show');
      }
    });


const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzxIw4N1eMDOvvyX_NqgBxW1NrzwSo-bvz6xn9Fw2nhmZPiXreP0RfZU9HsTK0Ezk0SlQ/exec"; 
const SECRET_KEY = "jayryan"; // Secret key for AES

if (!sessionStorage.getItem("loggedIn")) window.location.replace("login.html");

document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.clear();
  window.location.replace("login.html");
});




window.history.pushState(null,"",window.location.href);
window.addEventListener("popstate",()=>{if(!sessionStorage.getItem("loggedIn"))window.location.replace("login.html");else window.history.pushState(null,"",window.location.href);});

const toggleBtn = document.getElementById('themeToggle');
let darkMode = localStorage.getItem("theme") === "dark";

// Apply initial theme
applyTheme(darkMode);

toggleBtn.addEventListener('click', () => {
  darkMode = !darkMode;
  applyTheme(darkMode);
  localStorage.setItem("theme", darkMode ? "dark" : "light");
});

function applyTheme(isDark) {
  if (isDark) {
    document.documentElement.style.setProperty('--bg-color', '#1c1c1e');
    document.documentElement.style.setProperty('--text-color', '#f2f2f7');
    document.documentElement.style.setProperty('--card-bg', '#2c2c2e');
    document.documentElement.style.setProperty('--border-color', '#3a3a3c');
    document.documentElement.style.setProperty('--tab-active', '#0a84ff');
    toggleBtn.textContent = '‚òÄÔ∏è Light Mode';
  } else {
    document.documentElement.style.setProperty('--bg-color', '#f2f2f7');
    document.documentElement.style.setProperty('--text-color', '#1c1c1e');
    document.documentElement.style.setProperty('--card-bg', '#fff');
    document.documentElement.style.setProperty('--border-color', '#d1d1d6');
    document.documentElement.style.setProperty('--tab-active', '#007aff');
    toggleBtn.textContent = 'üåô Dark Mode';
  }
}


document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
    if(tab.dataset.tab==="tab2") loadRates();
    if(tab.dataset.tab==="tab3") loadTab3Data();
  });
});

document.querySelectorAll('#updateModal .modal-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const parent = tab.closest('.modal');

    // Remove active class sa lahat ng modal tabs at contents
    parent.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    parent.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));

    // Add active sa clicked tab at corresponding content
    tab.classList.add('active');
    const tabId = tab.dataset.tab;
    parent.querySelector(`#${tabId}`).classList.add('active');
  });
});


async function loadLogs(){
  const area=document.getElementById("areaFilter").value;
  const monthInput=document.getElementById("monthFilter");
  if(!monthInput.value){const today=new Date();monthInput.value=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}`;}
  const month=monthInput.value;
  const search=document.getElementById("searchName").value.trim();
  const tbody=document.getElementById("logsTable");
  tbody.innerHTML="<tr><td colspan='5'>Loading...</td></tr>";
  try{
    const res=await fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({action:"getLogs",area:area,month:month,search:search})});
    const data=await res.json();
    if(!data||data.length===0){tbody.innerHTML="<tr><td colspan='5'>No logs found</td></tr>";return;}
    data.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const uniqueAreas=[...new Set(data.map(r=>r.area).filter(a=>a))];
    const areaFilter=document.getElementById("areaFilter");areaFilter.innerHTML='<option value="">All Areas</option>';uniqueAreas.forEach(a=>{const opt=document.createElement("option");opt.value=a;opt.textContent=a;areaFilter.appendChild(opt);});
    tbody.innerHTML="";
    data.forEach(log=>{
      const row=`<tr>
        <td>${log.name?log.name.toUpperCase():"UNKNOWN"}</td>
        <td>${log.area?log.area.toUpperCase():"-"}</td>
        <td>${formatTimeCell(log.timeIn)}</td>
        <td>${formatTimeCell(log.timeOut)}</td>
        <td>${log.date}</td>
      </tr>`;tbody.insertAdjacentHTML("beforeend",row);
    });
  }catch(err){console.error(err);tbody.innerHTML="<tr><td colspan='5'>Error loading logs</td></tr>";}
}
function formatTimeCell(value){if(!value)return"-";const date=new Date(value);if(isNaN(date))return value;let h=date.getHours();const m=String(date.getMinutes()).padStart(2,'0');const ampm=h>=12?"PM":"AM";h=h%12;h=h===0?12:h;return`${h}:${m} ${ampm}`;}
document.addEventListener("DOMContentLoaded",loadLogs);

// --- Employee Deductions ---
window.employeeRates=[];
async function loadRates(){
  const tbody=document.getElementById("ratesTable");
  tbody.innerHTML="<tr><td colspan='6'>Loading...</td></tr>";
  try{
    const res=await fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({action:"getRates"})});
    const data=await res.json();
    
    if(!data||data.length===0){tbody.innerHTML="<tr><td colspan='6'>No rates found</td></tr>";return;}
    
    window.employeeRates = data.map(emp => ({
  id: emp.id || "",
  name: emp.employeeName || "UNKNOWN",
  area: emp.area || "-",
  designation: emp.designation || "-",
  monthlySalary: emp.basicmonthlySalary ? Number(emp.basicmonthlySalary).toFixed(2) : "0.00",

  // Mandatory deductions (manual input)
  sssDeduction: emp.sssDeduction || "",         // SSS deduction
  phicDeduction: emp.phicDeduction || "",       // PhilHealth deduction
  hdmfDeduction: emp.hdmfDeduction || "",       // Pag-IBIG deduction
  applyMandatoryAll: emp.applyMandatoryAll || false, // Checkbox para apply lahat ng mandatory

  // Voluntary deductions
  voluntaryDeduction: emp.voluntaryDeduction || "",
  voluntaryStart: emp.voluntaryStart || "",
  voluntaryEnd: emp.voluntaryEnd || "",

  attendanceDeduction: emp.attendanceDeduction || ""
}));


    renderRates(window.employeeRates);
  }catch(err){console.error(err);tbody.innerHTML="<tr><td colspan='6'>Error loading rates</td></tr>";}
}


function preloadEmployees() {
  fetch(`${WEB_APP_URL}?action=getAllEmployeesWithDeductions`)
    .then(res => res.json())
    .then(data => {
      employeesData = data; // lahat ng deductions kasama
      renderEmployeeTable(data); // i-populate ang table
    })
    .catch(err => console.error("Failed to preload employees:", err));
}

// Call on page load
preloadEmployees();

function renderRates(rates){
  const tbody = document.getElementById("ratesTable");
  tbody.innerHTML = "";

  if(rates.length === 0){
    tbody.innerHTML = "<tr><td colspan='6'>No matching employees</td></tr>";
    return;
  }

  rates.forEach(emp => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${emp.id}</td>
      <td>${emp.name}</td>
      <td>${emp.area}</td>
      <td>${emp.designation}</td>
      <td>‚Ç±${emp.monthlySalary}</td>
      <td>
        <button class="addition-btn">‚ûï Addition</button>
        <button class="update-btn">‚ûñ Deduction</button>
      </td>
    `;

    tbody.appendChild(row);

    // Add event listeners safely
    const updateBtn = row.querySelector(".update-btn");
    updateBtn.addEventListener("click", () => openUpdateEmployeeModal(emp));

    const additionBtn = row.querySelector(".addition-btn");
    additionBtn.addEventListener("click", () => openAdditionModal(emp));
  });
}




function openUpdateEmployeeModalById(btn) {
  const empId = btn.dataset.id;
  const emp = window.employeeRates.find(e => e.id === empId);
  if(!emp) return alert("Employee not found");
  openUpdateEmployeeModal(emp);
}


document.getElementById("rateSearch").addEventListener("input",()=>{
  const search=document.getElementById("rateSearch").value.toLowerCase();
  const filtered=window.employeeRates.filter(emp=>emp.name.toLowerCase().includes(search));
  renderRates(filtered);
});



// ---------------- Tab3: Payroll Printing ----------------
async function loadTab3Data(){
  const tbody = document.getElementById("tab3Body");
  tbody.innerHTML = "<tr><td colspan='17'>Loading...</td></tr>";
  try{
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({ action: "payroll" })
    });
    const data = await res.json();

    if(!data || data.length === 0){
      tbody.innerHTML = "<tr><td colspan='17'>No data found</td></tr>";
      return;
    }

    tbody.innerHTML = "";
    data.forEach(emp=>{
      const row = `<tr>
        <td>${emp.name}</td>
        <td>${emp.designation || ""}</td>
        <td>${Number(emp.monthly).toLocaleString()}</td>
        <td>${(emp.totalBasic/emp.days || 0).toFixed(2)}</td>
        <td>${((emp.totalBasic/emp.days || 0)/8).toFixed(2)}</td>
        <td>${emp.days}</td>
        <td>${Number(emp.totalBasic).toLocaleString()}</td>
        <td>${emp.allowance}</td>
        <td>${emp.restday || 0}</td>
        <td>${emp.overtime || 0}</td>
        <td>${emp.phic}</td>
        <td>${emp.hdmf}</td>
        <td>${emp.sss}</td>
        <td>${emp.salaryAdv}</td>
        <td>${emp.lateUndertime}</td>
        <td>${Number(emp.netPay).toLocaleString()}</td>
        <td></td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });
    computeTotals();
  }catch(err){
    console.error(err);
    tbody.innerHTML="<tr><td colspan='17'>Error loading data</td></tr>";
  }
}


// ---------------- Download Excel ----------------
function downloadExcel(){
  const table = document.getElementById("tab3Table").outerHTML;
  const html=`<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body>${table}</body></html>`;
  const blob=new Blob([html],{type:"application/vnd.ms-excel"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="payroll_tab3.xls";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
function computeTotals(){
  const tbody = document.getElementById("tab3Body");
  const rows = tbody.querySelectorAll("tr");
  const totalRow = document.getElementById("totalRow");
  const totalCells = totalRow.querySelectorAll("td");

  // initialize totals per column
  let totals = Array(totalCells.length).fill(0);

  rows.forEach(row=>{
    const cells = row.querySelectorAll("td");
    cells.forEach((cell,i)=>{
      let val = cell.textContent.replace(/,/g,"").trim(); 
      if(!isNaN(val) && val !== "" && i >= 2 && i <= 15){ 
        totals[i] += parseFloat(val);
      }
    });
  });

  // apply totals
  totals.forEach((t,i)=>{
    if(i >= 2 && i <= 15){
      totalCells[i].textContent = t.toLocaleString(undefined,{
        minimumFractionDigits:0,
        maximumFractionDigits:2
      });
    }
  });
}
// --- QR Modal ---
const qrModal = document.getElementById("qrModal");
const openQrBtn = document.getElementById("scanQRBtn");
const closeQrBtn = document.getElementById("closeQrModal");
const qrInput = document.getElementById("qrInput");

// Track last scanned QR ID to prevent duplicates
let lastScanId = null;

openQrBtn.addEventListener("click", () => {
  qrModal.classList.add("show");
  qrInput.value = "";
  qrInput.focus();
});

closeQrBtn.addEventListener("click", () => {
  qrModal.classList.remove("show");

   // Clear all modal inputs
  document.getElementById("qrInput").value = "";
  document.getElementById("empID").value = "";
  document.getElementById("empName").value = "";
  document.getElementById("empArea").value = "";
  empDesignation.value = "";
  empSalary.value = "";

  // Reset toggle and disable fields
  empDesignation.disabled = true;
  empSalary.disabled = true;
  toggleEditBtnAdd.textContent = "Edit Details";
});

window.addEventListener("click", e => { if(e.target===qrModal) qrModal.classList.remove("show"); });

// --- Function to open modals dynamically ---
function openModal(modalId){
  document.getElementById(modalId).classList.add("show");
}
function closeModal(modalId){

  const modal = document.getElementById(modalId);modal.classList.remove("show");

  const inputs = modal.querySelectorAll("input");
  inputs.forEach(input => input.value = "");
}

// --- Toggle Designation & Salary ---
const toggleEditBtnAdd = document.getElementById("toggleEditBtnAdd");
const empDesignation = document.getElementById("empDesignation");
const empSalary = document.getElementById("empSalary");

toggleEditBtnAdd.addEventListener("click", () => {
  const editable = empDesignation.disabled; // true if currently disabled
  empDesignation.disabled = !editable;
  empSalary.disabled = !editable;
  empDesignation.style.backgroundColor = editable ? "#fff" : "#f0f0f0";
  empSalary.style.backgroundColor = editable ? "#fff" : "#f0f0f0";
  toggleEditBtnAdd.textContent = editable ? "Lock Details" : "Edit Details";
});

const toggleEditUpdate = document.getElementById("toggleEditUpdate");
const empDesignationUp = document.getElementById("empDesignationUp");
const empSalaryUp = document.getElementById("empSalaryUp");

// toggle handler
toggleEditUpdate.addEventListener("change", () => {
  if (toggleEditUpdate.checked) {
    empDesignationUp.disabled = false;
    empSalaryUp.disabled = false;
    empDesignationUp.style.backgroundColor = "#fff";
    empSalaryUp.style.backgroundColor = "#fff";
  } else {
    empDesignationUp.disabled = true;
    empSalaryUp.disabled = true;
    empDesignationUp.style.backgroundColor = "#e9ecef";
    empSalaryUp.style.backgroundColor = "#e9ecef";
  }
});

// ‚úÖ force reset on page load
window.addEventListener("load", () => {
  toggleEditUpdate.checked = false;
  empDesignationUp.disabled = true;
  empSalaryUp.disabled = true;
  empDesignationUp.style.backgroundColor = "#e9ecef";
  empSalaryUp.style.backgroundColor = "#e9ecef";
});







// --- Pending Employees after QR scan ---
window.pendingEmployees = [];


// Render pending employees table
function renderPendingEmployees(){
  const tbody = document.getElementById("ratesTable");
  tbody.innerHTML = "";

  if(window.pendingEmployees.length === 0){
    tbody.innerHTML = "<tr><td colspan='6'>No employees scanned</td></tr>";
    return;
  }

  window.pendingEmployees.forEach(emp => {
    const row = document.createElement("tr");

    // Highlight if designation or salary is blank
    let highlightClass = "";
    if(!emp.designation || !emp.salary) highlightClass = "incomplete";

    row.innerHTML = `
      <td class="${highlightClass}">${emp.id}</td>
      <td class="${highlightClass}">${emp.name}</td>
      <td class="${highlightClass}">${emp.area}</td>
      <td class="${highlightClass}">${emp.designation || "-"}</td>
      <td class="${highlightClass}">${emp.salary ? "‚Ç±" + Number(emp.salary).toFixed(2) : "-"}</td>
      <td>
        <button onclick='editPendingEmployee("${emp.id}")'>‚úèÔ∏è Update</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Edit employee from pending table
function editPendingEmployee(empId){
  const emp = window.pendingEmployees.find(e => e.id === empId);
  if(!emp) return alert("Employee not found");

  // Fill modal
  document.getElementById("empID").value = emp.id;
  document.getElementById("empName").value = emp.name;
  document.getElementById("empArea").value = emp.area;
  empDesignation.value = emp.designation || "";
  empSalary.value = emp.salary || "";

  // Enable editing
  empDesignation.disabled = false;
  empSalary.disabled = false;
  empDesignation.style.backgroundColor = "#fff";
  empSalary.style.backgroundColor = "#fff";
  toggleEditBtn.textContent = "Lock Details";

  // Remove from pending array (will re-add on submit)
  window.pendingEmployees = window.pendingEmployees.filter(e => e.id !== empId);
  renderPendingEmployees();

  qrModal.classList.add("show");
}

// Add CSS for incomplete highlight dynamically (optional if not in CSS file)
const style = document.createElement('style');
style.textContent = `
  .incomplete {
    background-color: #fff3cd;
    font-weight: bold;
  }
`;
document.head.appendChild(style);

function decryptQR(encrypted) {
  try {
    const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8);

    if (!decrypted) {
      console.error("‚ö†Ô∏è Empty decrypted text - possible wrong key or corrupted QR.");
      return null;
    }

    return JSON.parse(decrypted);
  } catch (err) {   
    console.error("Decryption error:", err);
    return null;
  }
}

// --- Prevent bad paste characters ---
qrInput.addEventListener("paste", (e) => {
  e.preventDefault();
  let paste = (e.clipboardData || window.clipboardData).getData('text');
  paste = paste.trim().replace(/[\r\n\t]+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '');
  qrInput.value = paste;
});

// --- QR input handling ---
qrInput.addEventListener("keydown", (e) => {
  if (e.key !== "Enter") return;
  e.preventDefault();

  let qrData = qrInput.value.trim().replace(/[\r\n\t]+/g, '');
  if(!qrData) return;

  let data;
  try {
    data = decryptQR(qrData);
    if(!data) throw new Error("Invalid QR");
  } catch(err) {
    alert("Invalid or corrupted QR code!");
    qrInput.value = "";
    return;
  }

  // Prevent same QR from being scanned repeatedly
  if(data.id === lastScanId) {
    alert("‚ö†Ô∏è This QR has already been scanned!");
    qrInput.value = "";
    return;
  }
  lastScanId = data.id;

  // Auto-fill inputs
  document.getElementById("empID").value = data.id || "";
  document.getElementById("empName").value = data.name || "";
  document.getElementById("empArea").value = data.area || "";
  empDesignation.value = data.designation || "";
  empSalary.value = data.salary || "";
  empDesignation.disabled = true;
  empSalary.disabled = true;
  toggleEditBtn.textContent = "Edit Details";

  qrInput.value = "";

  // Optional auto-clear modal fields after 10 seconds (non-intrusive)
  setTimeout(() => {
    if(qrModal.classList.contains("show")) return; // do not clear if modal still open
    document.getElementById("empID").value = "";
    document.getElementById("empName").value = "";
    document.getElementById("empArea").value = "";
    empDesignation.value = "";
    empSalary.value = "";
  }, 10000);
});
// --- Add Employee to Google Sheet ---
document.getElementById("submitQRBtn").addEventListener("click", async () => {
  const id = document.getElementById("empID").value.trim();
  const name = document.getElementById("empName").value.trim();
  const area = document.getElementById("empArea").value.trim();
  const designation = empDesignation.value.trim();
  const salary = empSalary.value.trim();

  if (!id || !name || !area) {
    alert("‚ö†Ô∏è Employee ID, Name, and Area are required!");
    return;
  }

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "addEmployee",
        id,
        name,
        area,
        designation,
        salary
      })
    });

    const result = await res.json();
    console.log("Backend response:", result);
    if (result.success) {
      alert("‚úÖ Employee added successfully!");

      // refresh rates table
      loadRates();

      // close modal
      qrModal.classList.remove("show");

      // clear fields
      document.getElementById("empID").value = "";
      document.getElementById("empName").value = "";
      document.getElementById("empArea").value = "";
      empDesignation.value = "";
      empSalary.value = "";
    } else {
      alert(result.message || "‚ùå Failed to add employee!");
    }
  } catch (err) {
    console.error("Add Employee error:", err);
    alert("‚ö†Ô∏è Error saving employee!");
  }
});


let employeesData = [];

// ----------------------
// 1Ô∏è‚É£ Preload all employees
// ----------------------
function preloadEmployees() {
  fetch(`${WEB_APP_URL}?action=getAllEmployeesWithDeductions`)
    .then(res => res.json())
    .then(data => {
      employeesData = data; // lahat ng deductions kasama
      renderEmployeeTable(data); // optional kung gusto mo ipakita sa table
    })
    .catch(err => console.error("Failed to preload employees:", err));
}

// ----------------------
// 2Ô∏è‚É£ Render employee table (optional)
// ----------------------
function renderEmployeeTable(data) {
  const tbody = document.getElementById("ratesTable");
  tbody.innerHTML = "";

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='6'>No employees found</td></tr>";
    return;
  }

  data.forEach(emp => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${emp.id}</td>
      <td>${emp.name}</td>
      <td>${emp.area}</td>
      <td>${emp.designation}</td>
      <td>‚Ç±${emp.monthlySalary}</td>
      <td>
        <button class="update-btn">‚ûñ Deduction</button>
      </td>
    `;
    tbody.appendChild(row);

    // Click event ‚Üí instant modal fill
    const btn = row.querySelector(".update-btn");
    btn.addEventListener("click", () => openUpdateEmployeeModal(emp));
  });
}

// ----------------------
// 3Ô∏è‚É£ Open update modal instantly
// ----------------------
function openUpdateEmployeeModal(emp) {
  console.log("EMP object received:", emp);

  // Fill basic info
  document.getElementById("empNameUp").value = emp.name || "";
  document.getElementById("empIDUp").value = emp.id || "";
  document.getElementById("empAreaUp").value = emp.area || "";
  document.getElementById("empDesignationUp").value = emp.designation || "";
  document.getElementById("empSalaryUp").value = emp.monthlySalary || "";

  // Fill deductions instantly
  document.getElementById("phicDeduction").value = emp.phicDeduction || 0;
  document.getElementById("hdmfDeduction").value = emp.hdmfDeduction || 0;
  document.getElementById("sssDeduction").value = emp.sssDeduction || 0;

  // Lock fields if needed
  document.getElementById("empDesignationUp").disabled = true;
  document.getElementById("empSalaryUp").disabled = true;

  // Show modal
  const modal = document.getElementById("updateModal");
  modal.classList.add("show");
  modal.style.display = "flex";
}

// ----------------------
// 4Ô∏è‚É£ Initialize on page load
// ----------------------
document.addEventListener("DOMContentLoaded", preloadEmployees);


// ‚úÖ Move this outside the function
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("updateModal").classList.remove("show");

  // Optional: clear all fields
  const inputs = document.getElementById("updateModal").querySelectorAll("input");
  inputs.forEach(i => i.value = "");
});

  
// --- Save Update Button ---
document.getElementById("saveUpdateBtn").addEventListener("click", async () => {
  // Employee Information
  const id = document.getElementById("empIDUp").value.trim();
  const name = document.getElementById("empNameUp").value.trim();
  const area = document.getElementById("empAreaUp").value.trim();
  const designation = document.getElementById("empDesignationUp").value.trim();
  const salary = document.getElementById("empSalaryUp").value.trim();

  // Mandatory Deductions
  const phic = document.getElementById("phicDeduction")?.value.trim() || "";
  const hdmf = document.getElementById("hdmfDeduction")?.value.trim() || "";
  const sss = document.getElementById("sssDeduction")?.value.trim() || "";

  // Voluntary Deductions
  const voluntary = document.getElementById("empVoluntaryUp")?.value.trim() || "";

  if (!id || !name) {
    alert("‚ö†Ô∏è Missing Employee ID or Name!");
    return;
  }

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "updateEmployeeAll",
        id,
        name,
        area,
        designation,
        salary,
        phic,
        hdmf,
        sss,
        voluntary
      })
    });

    const result = await res.text();
    console.log("Update response:", result);

    if (result === "OK") {
      alert("‚úÖ Employee info and deductions updated successfully!");
      document.getElementById("updateModal").classList.remove("show");
      loadRates(); // refresh table
    } else if (result === "NOT_FOUND") {
      alert("‚ùå Employee not found!");
    } else {
      alert("‚ö†Ô∏è Error updating employee!");
    }
  } catch (err) {
    console.error("Update error:", err);
    alert("‚ùå Network error, please try again!");
  }
});


const volDeductionType = document.getElementById("volDeductionType");
const volDeductionAmount = document.getElementById("volDeductionAmount");
const volToggle = document.getElementById("voluntaryToggle");
const caOptions = document.getElementById("cashAdvanceOptions");
const caInstallment = document.getElementById("caInstallment");
const caFields = document.querySelector(".ca-fields");

volToggle.addEventListener("change", function(){
  const enabled = this.checked;
  volDeductionType.disabled = !enabled;
  volDeductionAmount.disabled = !enabled;
  if(!enabled){
    volDeductionType.value = "";
    volDeductionAmount.value = "";
    caOptions.style.display = "none";
    caInstallment.checked = false;
    caFields.style.display = "none";
  }
});

volDeductionType.addEventListener("change", function(){
  volDeductionAmount.disabled = this.value === "";
  
  if(this.value === "cashAdvance"){
    caOptions.style.display = "block"; // show extra options
  } else {
    caOptions.style.display = "none"; // hide if not CA
    caInstallment.checked = false;
    caFields.style.display = "none";
  }
});

caInstallment.addEventListener("change", function(){
  caFields.style.display = this.checked ? "grid" : "none";
});
volDeductionType.addEventListener("change", function(){
  if(this.value === "cashAdvance"){
    volDeductionAmount.disabled = true; // disable main amount input
    volDeductionAmount.value = "";      // clear it
    caOptions.style.display = "block";  // show extra options
  } else {
    volDeductionAmount.disabled = this.value === ""; // normal logic
    caOptions.style.display = "none";   // hide CA options
    caInstallment.checked = false;
    caFields.style.display = "none";
  }
});



document.getElementById("voluntaryToggle").addEventListener("change", function(){
  const disabled = !this.checked;
  document.querySelectorAll("#tab3modal input").forEach(inp=>{
    if(inp.type !== "checkbox") inp.disabled = disabled;
  });
});

// helper function para mag toggle
function setupToggle(toggleId, inputId) {
  const toggle = document.getElementById(toggleId);
  const input = document.getElementById(inputId);

  // Default: disabled
  input.disabled = true;

  toggle.addEventListener("change", () => {
    if (toggle.checked) {
      // Enable editing
      input.disabled = false;
      input.style.backgroundColor = "#fff";
      input.style.fontStyle = "normal";
      input.style.color = "#000";
    } else {
      // Disable again, keep value
      input.disabled = true;
      input.style.backgroundColor = "#f1f1f1";
      input.style.fontStyle = "italic";
      input.style.color = "#555";
    }
  });
}


// setup bawat deduction
setupToggle("toggleSSS", "sssDeduction");
setupToggle("togglePHIC", "phicDeduction");
setupToggle("toggleHDMF", "hdmfDeduction");

// kapag save, lahat balik sa disabled at untoggle
document.getElementById("saveUpdateBtn").addEventListener("click", () => {
  ["toggleSSS", "togglePHIC", "toggleHDMF"].forEach((toggleId) => {
    const toggle = document.getElementById(toggleId);
    const input = document.getElementById(toggle.dataset.inputId || toggleId.replace("toggle","").toLowerCase() + "Deduction");
    
    toggle.checked = false;
    input.disabled = true;
    input.style.backgroundColor = "#e9ecef";
  });

  alert("Deductions saved successfully!");
});
document.querySelectorAll('.ios-tab--dropdown').forEach(tab => {
  tab.addEventListener('click', function (e) {
    e.stopPropagation(); // para hindi agad magsara

    let dropdownId = this.getAttribute('data-dropdown');
    let dropdown = document.getElementById(dropdownId);

    // isara muna lahat ng dropdowns
    document.querySelectorAll('.ios-dropdown').forEach(menu => {
      if (menu !== dropdown) menu.style.display = "none";
    });

    // toggle yung napiling dropdown
    dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
  });
});

// kapag nag-click sa labas ng header, isasara lahat ng dropdowns
window.addEventListener('click', function () {
  document.querySelectorAll('.ios-dropdown').forEach(menu => {
    menu.style.display = "none";
  });
});

// Attendance Logs (main tab button)
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    // remove all active
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));

    // activate selected
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// Dropdown links (Adjustments + Reports)
document.querySelectorAll("[data-target]").forEach(link=>{
  link.addEventListener("click", function(e){
    e.preventDefault();

    const targetId = this.dataset.target;

    // remove all active
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));

    // activate the selected section
    document.getElementById(targetId).classList.add("active");

    // load functions kung meron
    if(targetId==="tab2") loadRates();
    if(targetId==="tab3") loadTab3Data(); // payroll na ito
    if(targetId==="tab4") loadTimeInArea();
    if(targetId==="tab5") load13thMonth();
  });
});

  function formatTime(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return "-"; // kapag invalid
    return d.toLocaleTimeString("en-PH", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true
    });
  }



function renderTimeInOutReport(logs) {
  const tableHead = document.getElementById("tab4Head");
  const tableBody = document.getElementById("tab4Body");

  tableHead.innerHTML = "";
  tableBody.innerHTML = "";

  if (!logs || logs.length === 0) {
    tableBody.innerHTML = "<tr><td colspan='100%'>No records found</td></tr>";
    return;
  }

  // ‚úÖ Apply area filter
  const selectedArea = document.getElementById("areaFilter").value;
  const filteredLogs = selectedArea ? logs.filter(l => l.area === selectedArea) : logs;

  if (!filteredLogs.length) {
    tableBody.innerHTML = "<tr><td colspan='100%'>No records found</td></tr>";
    return;
  }

  // ‚úÖ Unique dates
  const allDates = [...new Set(filteredLogs.map(l => l.date))].sort();

 // ‚úÖ HEADER: Row 1 (dates only)
let headerRow1 = "<tr><th></th>"; // empty for EMPLOYEE NAME
allDates.forEach(d => {
  headerRow1 += `<th colspan='2'>${d}</th>`;
});
headerRow1 += "</tr>";

// ‚úÖ HEADER: Row 2 (EMPLOYEE NAME + IN/OUT)
let headerRow2 = "<tr><th>EMPLOYEE NAME</th>";
allDates.forEach(() => {
  headerRow2 += "<th>IN</th><th>OUT</th>";
});
headerRow2 += "</tr>";

tableHead.innerHTML = headerRow1 + headerRow2;


  // ‚úÖ Group logs by employee
  const grouped = {};
  filteredLogs.forEach(log => {
    if (!grouped[log.name]) grouped[log.name] = {};
    grouped[log.name][log.date] = log;
  });

  // ‚úÖ BODY rows
  Object.keys(grouped).forEach(name => {
    let rowHtml = `<tr><td class="nameCell">${name}</td>`;

    allDates.forEach(d => {
      const log = grouped[name][d];
      if (log) {
        rowHtml += `<td>${formatTime(log.timeIn)}</td><td>${formatTime(log.timeOut)}</td>`;
      } else {
        rowHtml += "<td>-</td><td>-</td>";
      }
    });

    rowHtml += "</tr>";
    tableBody.innerHTML += rowHtml;
  });

  // ‚úÖ AUTO ADJUST: Make columns fit content
  const table = document.getElementById("tab4Table");
  const nameCells = table.querySelectorAll("th:first-child, td.nameCell");

  // Sticky first column
  nameCells.forEach(cell => {
    cell.style.position = "sticky";
    cell.style.left = "0";
    cell.style.background = "#f0f0f0";
    cell.style.zIndex = 3;
    cell.style.paddingLeft = "5px";
    cell.style.textAlign = "left";
    cell.style.whiteSpace = "nowrap"; // prevent line break
  });

  // Let other columns auto-fit content
  table.querySelectorAll("thead th:not(:first-child), tbody td:not(.nameCell)").forEach(cell => {
    cell.style.whiteSpace = "nowrap";  // optional: prevents breaking
    cell.style.textAlign = "center";
  });
}


function formatTime(timeStr) {
  if (!timeStr) return "-";
  const d = new Date(timeStr);
  if (isNaN(d.getTime())) return "-";

  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2, "0");

  // Convert to 12-hour format
  hours = hours % 12;
  if (hours === 0) hours = 12; // midnight/noon correction

  return `${hours}:${minutes}`; // ‚úÖ 12-hour without AM/PM
}



async function loadTimeInArea() {
  const start = document.getElementById("timeinStart").value;
  const end = document.getElementById("timeinEnd").value;
  
  document.getElementById("dateRangeLabel").textContent = `${start} - ${end}`;

  try {
    const res = await fetch(
      `https://script.google.com/macros/s/AKfycbzxIw4N1eMDOvvyX_NqgBxW1NrzwSo-bvz6xn9Fw2nhmZPiXreP0RfZU9HsTK0Ezk0SlQ/exec?action=getTimeLogs&start=${start}&end=${end}`
    );
    const data = await res.json();

    console.log("Logs response:", data); // üü¢ DEBUG

    if (!Array.isArray(data)) {
      document.getElementById("tab4Body").innerHTML =
        "<tr><td colspan='4'>No valid data found</td></tr>";
      return;
    }

    // Populate area dropdown dynamically
    populateAreaDropdown(data);

    // Render table initially with all data
    renderTimeInOutReport(data);

  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("tab4Body").innerHTML =
      "<tr><td colspan='4'>Error loading data</td></tr>";
  }
}

function populateAreaDropdown(data) {
  const areaSelect = document.getElementById("areaFilter");

  // Get unique areas
  const areas = [...new Set(data.map(item => item.area))].sort();

  // Clear existing options except "All Areas"
  areaSelect.innerHTML = '<option value="">All Areas</option>';

  // Add options
  areas.forEach(area => {
    const option = document.createElement("option");
    option.value = area;
    option.textContent = area;
    areaSelect.appendChild(option);
  });
}

// ‚úÖ Debug: check if function is defined
console.log("populateAreaDropdown defined?", typeof populateAreaDropdown);


</script>
</body>
</html>
