<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employee Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
body {
  margin:0;
  font-family:'Inter', sans-serif;
  background:#f4f6f9;
  color:#333;
  display:flex;
  height:100vh;
  font-size:13px;
}

/* Sidebar */
.sidebar {
  width:200px;
  background:#0a2a43;
  color:white;
  display:flex;
  flex-direction:column;
  padding:20px 12px;
  height:100vh;
  transition: transform 0.3s ease;
}
.sidebar h2 { font-size:15px; margin-bottom:18px; font-weight:600; }
.tabs { display:flex; flex-direction:column; gap:4px; }
.tabs button {
  padding:6px 10px;
  border:none;
  background:#0a2a43;
  color:white;
  text-align:left;
  font-weight:500;
  border-radius:5px;
  cursor:pointer;
  transition:0.3s;
  font-size:12px;
}
.tabs button.active, .tabs button:hover { background:#0d3a5f; }
.sidebar .close-sidebar { display:none; align-self:flex-end; font-size:18px; background:none; border:none; color:white; cursor:pointer; margin-bottom:10px; }

/* Main content */
.main { flex:1; display:flex; flex-direction:column; overflow:auto; padding:16px; }
.topbar { display:flex; justify-content:space-between; align-items:center; background:#fff; padding:12px 20px; box-shadow:0 2px 6px rgba(0,0,0,0.08); font-size:13px; }
.topbar .title { font-weight:600; color:#0a2a43; transition:0.3s; }
.topbar .welcome { color:#0a2a43; }
.topbar button { background:#e53e3e; border:none; color:white; padding:4px 10px; border-radius:6px; cursor:pointer; font-weight:500; font-size:12px; transition:0.3s; }
.topbar button:hover { background:#c53030; }
.hamburger { display:none; font-size:20px; background:none; border:none; color:#0a2a43; cursor:pointer; }

/* Tabs */
.tab-content { display:none; animation:fadeIn 0.3s ease-in-out; margin-top: 20px; }
.tab-content.active { display:block; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

/* Cards */
.card, .card-attendance, .emp-card { background:white; border-radius:10px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:14px; }

/* Cards container */
.cards-container { display:flex; gap:20px; }
.cards-container .card { flex:1; }

/* Card headings */
.card h2, .emp-card h2 { margin-top:0; margin-bottom:10px; font-size:14px; color:#0a2a43; font-weight:600; border-bottom:1px solid #e0e4e8; padding-bottom:4px; }

/* Modern table design */
table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  border-radius:10px;
  overflow:hidden;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}
thead th { background:#0a2a43; color:white; padding:8px; text-align:center; }
tbody td { padding:8px; text-align:center; border-bottom:1px solid #eee; }
tbody tr:nth-child(even) { background:#f9f9f9; }
tbody tr:hover { background:#e0f0ff; transition:0.2s; }

/* Forms */
.emp-form-group { display:flex; flex-direction:column; margin-bottom:10px; font-size:13px; }
.emp-form-group input, .emp-form-group textarea {
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #ccc;
  font-family:'Inter',sans-serif;
}
.emp-form-group textarea { min-height:50px; resize:vertical; }
.emp-btn { padding:6px 12px; border-radius:6px; background:#0a2a43; color:white; border:none; cursor:pointer; font-weight:500; transition:0.3s; }
.emp-btn:hover { background:#0d3a5f; }

/* Responsive */
@media(max-width:768px){
  .sidebar { position:fixed; left:0; top:0; height:100%; transform:translateX(-100%); z-index:1000; }
  .sidebar.show { transform:translateX(0); }
  .sidebar .close-sidebar { display:block; }
  .main { flex:1; padding:12px; }
  .hamburger { display:block; }
  .topbar .title { display:none; }
  .cards-container { flex-direction:column; }
}

/* Modern minimalist date input */
input[type="date"] {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 6px 10px;
  font-size: 13px;
  font-family: 'Inter', sans-serif;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #fff;
  color: #333;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  width: 150px;
}
input[type="date"]:hover { border-color: #0d3a5f; }
input[type="date"]:focus { outline:none; border-color:#0a2a43; box-shadow:0 0 0 2px rgba(10,42,67,0.2); }

/* Toast */
.toast {
  min-width: 220px;
  margin-bottom: 10px;
  background: #0a2a43;
  color: white;
  padding: 10px 16px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.5s ease-in-out;
  font-size: 13px;
}
.toast.show { opacity: 1; transform: translateX(0); }

/* Full Page Loader */
#fullPageLoader {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(255,255,255,0.7);
  z-index:9999;
  justify-content:center;
  align-items:center;
  font-size:18px;
  color:#0a2a43;
  font-weight:600;
}

#fullPageLoader .loader {
  border: 4px solid #f3f3f3; /* Light grey */
  border-top: 4px solid #0a2a43; /* Blue */
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


</style>
</head>
<body>

<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<!-- Full Page Loader -->
<div id="fullPageLoader">
  <div class="loader"></div>
  <div style="margin-left:10px;">Submitting...</div>
</div>

<div class="sidebar" id="sidebar">
  <button class="close-sidebar" onclick="toggleSidebar()">×</button>
  <h2>Employee Dashboard</h2>
  <div class="tabs">
    <button class="tab-btn active" data-tab="attendanceTab">Attendance Logs</button>
    <button class="tab-btn" data-tab="overtimeTab">Overtime Requests</button>
    <button class="tab-btn" data-tab="excuseTab">Excuse Requests</button>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <button class="hamburger" onclick="toggleSidebar()">☰</button>
    <div class="title">Simpal Group of Companies</div>
    <div class="welcome">Welcome, <span id="userNameDisplay">Employee</span></div>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Attendance Tab -->
  <div id="attendanceTab" class="tab-content active">
    <div class="cards-container">
      <div class="card" id="profileCard">
        <h2>Profile</h2>
        <div><strong>Employee Name:</strong> <span id="profileName"></span></div>
        <div><strong>Employee ID:</strong> <span id="profileID"></span></div>
        <div><strong>Area:</strong> <span id="profileArea"></span></div>
        <div><strong>Designation:</strong> <span id="profileDesignation"></span></div>
        <div><strong>Basic Salary:</strong> <span id="profileSalary"></span></div>
        <div><strong>Day-Off:</strong> <span id="profileDayOff"></span></div>
        <div><strong>Time Exempted:</strong> <span id="profileTimeExempted"></span></div>
        <div><strong>Last Modified:</strong> <span id="profileDateModified"></span></div>
      </div>
      <div class="card" id="payslipCard">
        <h2>Payslips (Not Official)</h2>
        <div id="payslipLinks"></div>
        <small style="color:#888;">These are sample payslips for viewing only, not official.</small>
      </div>
    </div>
    <div class="card-attendance">
    <h2>Attendance Logs (Current Month)</h2>
    <div id="attendanceLogs" style="max-height:400px; overflow-y:auto; padding:5px;">
      <div style="text-align:center; color:#888;">Loading attendance logs...</div>
    </div>
  </div>
  </div>

  <!-- Overtime Tab -->
  <div id="overtimeTab" class="tab-content">
    <div class="emp-card">
      <h2>File Overtime Request</h2>
      <div class="emp-form-group">
        <label>Date of Overtime</label>
        <input type="date" id="otDate">
      </div>
      <div class="emp-form-group">
        <label>Hours</label>
        <input type="number" id="otHours" placeholder="Enter number of overtime hours">
      </div>
      <div class="emp-form-group">
        <label>Reason</label>
        <textarea id="otReason" placeholder="Explain reason for overtime"></textarea>
      </div>
      <button class="emp-btn" id="otSubmit">Submit</button>
    </div>
    <div class="emp-card" style="margin-top:10px;">
      <h3>Submitted Overtime Requests</h3>
      <table>
        <thead>
          <tr><th>Request Date</th><th>Hours</th><th>Reason</th><th>Timestamp</th><th>Status</th></tr>
        </thead>
        <tbody id="otTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Excuse Tab -->
  <div id="excuseTab" class="tab-content">
    <div class="emp-card">
      <h2>File Excuse Request</h2>
      <div class="emp-form-group">
        <label>Date of Absence</label>
        <input type="date" id="exDate">
      </div>
      <div class="emp-form-group">
        <label>Reason</label>
        <textarea id="exReason" placeholder="Explain why you were absent"></textarea>
      </div>
      <button class="emp-btn" id="exSubmit">Submit</button>
    </div>
    <div class="emp-card" style="margin-top:10px;">
      <h3>Submitted Excuse Requests</h3>
      <table>
        <thead>
          <tr><th>Request Date</th><th>Reason</th><th>Timestamp</th><th>Status</th></tr>
        </thead>
        <tbody id="exTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzxIw4N1eMDOvvyX_NqgBxW1NrzwSo-bvz6xn9Fw2nhmZPiXreP0RfZU9HsTK0Ezk0SlQ/exec";

// --- Toast ---
function showToast(message, duration=3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => container.removeChild(toast), 500);
  }, duration);
}

// --- Full Page Loader ---
function showFullPageLoader(show=true){
    const loader = document.getElementById('fullPageLoader');
    if(loader) loader.style.display = show ? 'flex' : 'none';
}

// --- Tabs ---
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    document.getElementById('sidebar').classList.remove('show');
  });
});

// --- Sidebar toggle & logout ---
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('show'); }
function logout(){ localStorage.removeItem('employeeUser'); location.reload(); }

// --- Utilities ---
function capitalizeWords(str){ return str.toLowerCase().replace(/\b[a-z]/g, c=>c.toUpperCase()); }
function formatCurrency(n){ return isNaN(Number(n)) ? "-" : Number(n).toLocaleString("en-PH",{style:"currency",currency:"PHP"}); }
function formatDate(d){ return !d ? "-" : new Date(d).toLocaleDateString("en-PH",{day:"numeric",month:"long",year:"numeric"}); }
function formatString(s){ return s ? String(s).toUpperCase() : "-"; }

// --- Load user info ---
window.onload = function(){
  const user = JSON.parse(localStorage.getItem("employeeUser")||"{}");
  if(!user.username){ window.location.href="emp.login.html"; return; }

  document.getElementById("userNameDisplay").textContent = capitalizeWords(user.name||"Employee");
  document.getElementById("profileName").textContent = capitalizeWords(user.name||"-");
  document.getElementById("profileID").textContent = user.username||"-";
  document.getElementById("profileArea").textContent = user.area||"-";
  document.getElementById("profileDesignation").textContent = user.designation||"-";
  document.getElementById("profileSalary").textContent = formatCurrency(user.basicSalary);
  document.getElementById("profileDayOff").textContent = formatString(user.dayOff);
  document.getElementById("profileTimeExempted").textContent = formatString(user.timeExempted);
  document.getElementById("profileDateModified").textContent = formatDate(user.dateModified);

  loadEmployeeRequests();
  loadAttendanceLogs();
  const payslipContainer = document.getElementById("payslipLinks");
  const payslips = user.payslips||[];
  if(payslips.length===0) payslipContainer.innerHTML="<div style='color:#888;'>No payslip data available yet.</div>";
  else payslips.forEach(month=>{
    if(!Array.from(payslipContainer.children).some(c=>c.textContent===month+" Payslip")){
      const link=document.createElement("a"); link.href="#"; link.textContent=month+" Payslip"; payslipContainer.appendChild(link);
    }
  });
};

// --- Send Request ---
function sendRequest(type, date, hours, reason){
  const user = JSON.parse(localStorage.getItem("employeeUser") || "{}");
  const payload = new URLSearchParams({
    action: "submitRequest",
    id: user.username,
    date,
    type,
    hours: hours || "",
    reason
  });
  return fetch(SCRIPT_URL, { method: "POST", body: payload, mode: "no-cors" })
    .catch(err => { console.error(err); });
}

// --- Overtime ---
document.getElementById('otSubmit').addEventListener('click', () => {
  const dateInput = document.getElementById('otDate').value;
  const hours = document.getElementById('otHours').value;
  const reason = document.getElementById('otReason').value;
  if (!dateInput || !hours || !reason) { alert("Fill all fields"); return; }

  // Format Request Date: Day Month Year
  const formattedDate = new Date(dateInput).toLocaleDateString('en-PH', { day:'2-digit', month:'short', year:'numeric' });

  // Format Timestamp: Day Month Year, HH:MM:SS
  const formattedTimestamp = new Date().toLocaleString('en-PH', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' });

  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${formattedDate}</td><td>${hours}</td><td>${reason}</td><td>${formattedTimestamp}</td><td style="color:orange;font-weight:500;">Pending</td>`;
  document.getElementById('otTable').appendChild(tr);

  document.getElementById('otDate').value = '';
  document.getElementById('otHours').value = '';
  document.getElementById('otReason').value = '';

  showFullPageLoader(true);
  sendRequest("overtime", dateInput, hours, reason)
    .finally(() => { 
      showFullPageLoader(false); 
      showToast("Overtime request submitted!"); 
      loadEmployeeRequests(); 
    });
});

// --- Excuse ---
document.getElementById('exSubmit').addEventListener('click', () => {
  const dateInput = document.getElementById('exDate').value;
  const reason = document.getElementById('exReason').value;
  if (!dateInput || !reason) { alert("Fill all fields"); return; }

  // Format Request Date: Day Month Year
  const formattedDate = new Date(dateInput).toLocaleDateString('en-PH', { day:'2-digit', month:'short', year:'numeric' });

  // Format Timestamp: Day Month Year, HH:MM:SS
  const formattedTimestamp = new Date().toLocaleString('en-PH', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' });

  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${formattedDate}</td><td>${reason}</td><td>${formattedTimestamp}</td><td style="color:orange;font-weight:500;">Pending</td>`;
  document.getElementById('exTable').appendChild(tr);

  document.getElementById('exDate').value = '';
  document.getElementById('exReason').value = '';

  showFullPageLoader(true);
  sendRequest("excuse", dateInput, "", reason)
    .finally(() => { 
      showFullPageLoader(false); 
      showToast("Excuse request submitted!"); 
      loadEmployeeRequests(); 
    });
});

// --- Load Employee Requests ---
async function loadEmployeeRequests() {
  const user = JSON.parse(localStorage.getItem("employeeUser") || "{}");
  if (!user.username) return;

  const params = new URLSearchParams();
  params.append("action", "getRequests");
  params.append("id", user.username);

  try {
    const res = await fetch(SCRIPT_URL, { method: "POST", body: params });
    const data = await res.json();

    const otTable = document.getElementById('otTable');
    const exTable = document.getElementById('exTable');
    otTable.innerHTML = '';
    exTable.innerHTML = '';

    if (!Array.isArray(data) || data.length === 0) {
      otTable.innerHTML = '<tr><td colspan="5" style="color:#888;text-align:center;">No overtime requests found</td></tr>';
      exTable.innerHTML = '<tr><td colspan="4" style="color:#888;text-align:center;">No excuse requests found</td></tr>';
      return;
    }

    data.forEach(req => {
      const tr = document.createElement('tr');

      // Format RequestDate: Month Day, Year
      let requestDate = req['RequestDate'] ? new Date(req['RequestDate']) : null;
      let formattedRequestDate = requestDate ? requestDate.toLocaleDateString('en-PH', { day:'2-digit', month:'short', year:'numeric' }) : '-';

      // Format Timestamp: Day Month Year, HH:MM:SS
      let timestamp = req.Timestamp ? new Date(req.Timestamp) : null;
      let formattedTimestamp = timestamp ? timestamp.toLocaleString('en-PH', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' }) : '-';

      // Determine status color and weight
      let statusColor = "orange"; // default Pending
      let fontWeight = 500; // default
      if (req.Status?.toLowerCase() === "approved") { statusColor = "green"; fontWeight = 700; }
      else if (req.Status?.toLowerCase() === "rejected") statusColor = "red";

      if (req.Type.toLowerCase() === "overtime") {
        tr.innerHTML = `
          <td>${formattedRequestDate}</td>
          <td>${req.Hours || '-'}</td>
          <td>${req.Reason || '-'}</td>
          <td>${formattedTimestamp}</td>
          <td style="color:${statusColor};font-weight:${fontWeight};">${req.Status || '-'}</td>
        `;
        otTable.appendChild(tr);
      } else if (req.Type.toLowerCase() === "excuse") {
        tr.innerHTML = `
          <td>${formattedRequestDate}</td>
          <td>${req.Reason || '-'}</td>
          <td>${formattedTimestamp}</td>
          <td style="color:${statusColor};font-weight:${fontWeight};">${req.Status || '-'}</td>
        `;
        exTable.appendChild(tr);
      }
    });

  } catch (err) {
    console.error("❌ Error loading requests:", err);
  }
}

// Helper function to format time in AM/PM
function formatTime(timeStr) {
  if (!timeStr) return "-";
  
  // Split time into hours, minutes, seconds
  const parts = timeStr.split(':');
  if (parts.length < 2) return timeStr; // invalid format, return as-is

  let hours = parseInt(parts[0], 10);
  const minutes = parts[1].padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12; // convert 0 => 12
  return `${hours.toString().padStart(2,'0')}:${minutes} ${ampm}`;
}

async function loadAttendanceLogs() {
  const user = JSON.parse(localStorage.getItem("employeeUser") || "{}");
  if (!user.username) return;

  const now = new Date();
  const monthParam = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0"); // current month

  const params = new URLSearchParams();
  params.append("action", "getEmployeeLogs");
  params.append("id", user.username);
  params.append("month", monthParam);

  const container = document.getElementById('attendanceLogs');
  container.innerHTML = '<div style="text-align:center; color:#888;">Loading attendance logs...</div>';

  try {
    const res = await fetch(SCRIPT_URL, { method: "POST", body: params });
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = "<div style='color:#888;text-align:center;'>No attendance logs for this month</div>";
      return;
    }

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr style="background:#0a2a43; color:white;">
          <th>Date</th>
          <th>Time In</th>
          <th>Time Out</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${data.map(log => {
          const timeIn = formatTime(log.timeIn);
          const timeOut = formatTime(log.timeOut);
          const status = log.timeIn ? "Present" : "Absent";
          const color = log.timeIn ? "green" : "red";
          return `<tr>
            <td>${log.date}</td>
            <td>${timeIn}</td>
            <td>${timeOut}</td>
            <td style="color:${color}; font-weight:700;">${status}</td>
          </tr>`;
        }).join('')}
      </tbody>
    `;
    container.innerHTML = '';
    container.appendChild(table);

  } catch (err) {
    console.error(err);
    container.innerHTML = "<div style='color:red;text-align:center;'>Failed to load attendance logs</div>";
  }
}


  




</script>

</body>
</html>
