<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agents Attendance Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body { margin:0; display:flex; flex-direction:column; height:100vh; font-family:Arial,sans-serif; }
.back-header { display:flex; align-items:center; justify-content:space-between; background:#343a40; color:white; padding:10px 15px; }
.back-header button { background:#007bff; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:14px; transition:0.2s; }
.back-header button:hover { background:#0056b3; }
.back-header h2 { margin:0; font-size:18px; }
.content { display:flex; flex:1; }
#tableSection { width:35%; background:#f8f9fa; padding:15px; overflow-y:auto; }
#map { width:65%; height:100%; }
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ccc; padding:8px; text-align:left; }
th { background:#343a40; color:white; }
tr:hover { background:#dee2e6; cursor:pointer; }
.status-active { background:#d4edda; color:#155724; }
.status-far { background:#e2e3ff; color:#383d9a; }
.status-invalid { background:#f8d7da; color:#721c24; }
.qr-tab{position:fixed; top:50%; transform:translateY(-50%); width:40px; height:40px; background:#0ea5a4; display:flex; justify-content:center; align-items:center; border-radius:8px; cursor:pointer; box-shadow:0 6px 18px rgba(14,165,164,0.18); z-index:10002; transition: right 0.4s ease; right:0;}
.qr-tab img{width:30px; height:30px; object-fit:contain;}
.qr-drawer{position:fixed; right:0; top:50%; transform:translateY(-50%); width:20%; height:50%; background:#ffffff; border-radius:12px 0 0 12px; box-shadow:0 8px 30px rgba(17,24,39,0.12); overflow:auto; transition: transform 0.4s ease-in-out; z-index:10001; display:flex; flex-direction:column; transform: translateX(100%) translateY(-50%);}
.qr-drawer.open{transform: translateX(0) translateY(-50%);}
.qr-content{padding:18px; flex:1; display:flex; flex-direction:column; align-items:center;}
.controls{display:flex;gap:8px;margin-top:12px; width:100%; justify-content:center;}
.qr-preview{margin-top:14px;text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:200px;}
.qr-preview img, .qr-preview canvas{width:30VH; height:30VH; border-radius:8px; border:1px solid #e6e9ef; margin-bottom:8px;}
label{display:block;font-size:13px;margin-top:12px;color:#374151;}
select, input{width:100%;padding:6px;margin-top:6px;border-radius:6px;border:1px solid #ccc; box-sizing:border-box;}
a#downloadBtn {display:block; width:150px; text-align:center; padding:10px; background:#0ea5a4; color:#fff; border-radius:8px; text-decoration:none; font-weight:600; cursor:pointer;}
a#downloadBtn:hover {background:#0b7271;}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:10003; }
.modal-content { background:#fff; padding:20px; border-radius:8px; width:300px; max-width:90%; position:relative; }
.modal-content h3 { margin-top:0; }
.modal-content button.close { position:absolute; top:10px; right:10px; background:#f00; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
.modal-content button.close:hover { background:#c00; }
.modal-content button.action { background:#0ea5a4; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; width:100%; margin-top:10px; }
.modal-content button.action:hover { background:#0b7271; }
</style>
</head>
<body>

<div class="back-header">
  <button onclick="goBack()">‚Üê Back to Dashboard</button>
  <h2>Agents Attendance Map</h2>
  <div style="display:flex; gap:10px;">
    <button onclick="openModal('kioskModal')">Assign Kiosk</button>
    <button onclick="openModal('agentModal')">Assign Agent</button>
  </div>
</div>

<div class="content">
  <div id="tableSection">
    <h3>Attendance Logs</h3>
    <table id="attendanceTable">
      <thead><tr><th>Name</th><th>ID</th><th>Time</th><th>Location</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="map"></div>
</div>

<div class="qr-drawer" id="qrDrawer">
  <div class="qr-content">
    <div class="qr-preview" id="qrPreview"></div>
    <label>Select Area</label>
    <select id="areaSelect">
      <option value="MARAWI ">Marawi</option>
      <option value="COTABATO CITY">Cotabato</option>
      <option value="GENERAL SANTOS">General Santos</option>
    </select>
    <div class="controls">
      <a id="downloadBtn" href="#">Download QR</a>
    </div>
  </div>
</div>
<div class="qr-tab" id="qrTab"><img src="https://i.imgur.com/VgezC8W.png" alt="QR Tab"></div>

<!-- Kiosk Modal -->
<div class="modal" id="kioskModal">
  <div class="modal-content">
    <button class="close" onclick="closeModal('kioskModal')">X</button>
    <h3>Assign Kiosk</h3>
    <label>Kiosk Code</label><input type="text" id="kioskCodeInput" placeholder="MAR-001">
    <label>Latitude</label><input type="number" step="0.0001" id="kioskLat">
    <label>Longitude</label><input type="number" step="0.0001" id="kioskLng">
    <button class="action" onclick="addKiosk()">Add Kiosk</button>
  </div>
</div>

<!-- Agent Modal -->
<div class="modal" id="agentModal">
  <div class="modal-content">
    <button class="close" onclick="closeModal('agentModal')">X</button>
    <h3>Assign Agent</h3>
    <label>Agent Name</label><input type="text" id="agentNameInput" placeholder="Agent Name">
    <label>Select Kiosk</label>
    <select id="kioskSelect"></select>
    <button class="action" onclick="assignAgent()">Assign Agent</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Back button
function goBack() { window.history.back(); }

// Map
const southWest = L.latLng(4.0, 121.0);
const northEast = L.latLng(9.5, 128.0);
const mindanaoBounds = L.latLngBounds(southWest, northEast);
const map = L.map('map', { maxBounds: mindanaoBounds, maxBoundsViscosity:1.0 }).fitBounds(mindanaoBounds);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

// Sample attendance data
const attendanceData = [
  { name:'Agent Marawi', id:'M001', time:'08:15 AM', location:'Marawi', lat:8.0, lng:124.2936, status:'active' },
  { name:'Agent Cotabato', id:'C001', time:'08:20 AM', location:'Cotabato City', lat:7.2, lng:124.2467, status:'active' }
];
const tableBody = document.querySelector('#attendanceTable tbody');
attendanceData.forEach(agent=>{
  let color = agent.status==='active'?'green':agent.status==='far'?'blue':'red';
  const marker = L.circleMarker([agent.lat, agent.lng],{radius:8,color,fillColor:color,fillOpacity:0.8}).addTo(map);
  marker.bindPopup(`<b>${agent.name}</b><br>ID:${agent.id}<br>Time:${agent.time}<br>Location:${agent.location}<br>Status:${agent.status.toUpperCase()}`);
  const row = document.createElement('tr');
  row.classList.add(`status-${agent.status}`);
  row.innerHTML=`<td>${agent.name}</td><td>${agent.id}</td><td>${agent.time}</td><td>${agent.location}</td><td>${agent.status.toUpperCase()}</td>`;
  row.addEventListener('click',()=>{ map.setView([agent.lat, agent.lng],10); marker.openPopup(); });
  tableBody.appendChild(row);
});

// QR Generator + Database save
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzxIw4N1eMDOvvyX_NqgBxW1NrzwSo-bvz6xn9Fw2nhmZPiXreP0RfZU9HsTK0Ezk0SlQ/exec"; 
const qrTab = document.getElementById('qrTab');
const qrDrawer = document.getElementById('qrDrawer');
const qrDownload = document.getElementById('downloadBtn');
const areaSelect = document.getElementById('areaSelect');
const qrPreview = document.getElementById('qrPreview');
const seriesCounter = { MAR:0, COT:0, GEN:0 };
let currentGeneratedCode = "";

// Generate QR
function generateQR() {
  const areaFull = areaSelect.value.trim(); // buong pangalan mula sa dropdown
  const abbr = areaFull.substring(0,3).toUpperCase(); // unang 3 letters

  seriesCounter[abbr] = seriesCounter[abbr] || 0;
  seriesCounter[abbr]++;
  const code = `${abbr}-${String(seriesCounter[abbr]).padStart(3,'0')}`;
  currentGeneratedCode = code;

  qrPreview.innerHTML = '';
  const div = document.createElement('div');
  qrPreview.appendChild(div);
  new QRCode(div, { text: code, width: 150, height: 150, correctLevel: QRCode.CorrectLevel.H });

  setTimeout(() => {
    const c = div.querySelector('canvas');
    if(c){
      qrDownload.href = c.toDataURL();
      qrDownload.download = code + '.png';
    }
  }, 200);
}

qrDownload.addEventListener('click', async () => {
  const areaFull = areaSelect.value.trim();
  if (!areaFull) return alert("Select an area first");

  try {
    // Request sa backend: generate next code + save
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "saveAndGenerateKioskCode",
        area: areaFull
      })
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.message);

    currentGeneratedCode = data.code; // <- code mula sa database

    // Generate QR
    qrPreview.innerHTML = '';
    const div = document.createElement('div');
    qrPreview.appendChild(div);
    new QRCode(div, { text: currentGeneratedCode, width: 150, height: 150, correctLevel: QRCode.CorrectLevel.H });

    setTimeout(() => {
      const c = div.querySelector('canvas');
      if (c) {
        qrDownload.href = c.toDataURL();
        qrDownload.download = currentGeneratedCode + '.png';
      }
    }, 200);

    alert(`Kiosk code ${currentGeneratedCode} saved and QR generated!`);

  } catch (err) {
    console.error(err);
    alert("Error: " + err.message);
  }
});

async function loadNextCode(area) {
  const res = await fetch("WEBAPP_URL", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      action: "getNextKioskCode",
      area: area
    })
  });

  const data = await res.json();

  if (data.success) {
    document.getElementById("kioskCodeField").value = data.nextCode;
  } else {
    alert("Error loading next code: " + data.message);
  }
}


// Update QR when drawer opens or area changes
qrTab.addEventListener('click', () => {
  qrDrawer.classList.toggle('open');
  if (qrDrawer.classList.contains('open')) generateQR();
});
areaSelect.addEventListener('change', generateQR);
window.addEventListener('load', generateQR);


// Modals
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }

// Kiosks
let kiosks=[];
function addKiosk(){
  const code=document.getElementById('kioskCodeInput').value.trim();
  const lat=parseFloat(document.getElementById('kioskLat').value);
  const lng=parseFloat(document.getElementById('kioskLng').value);
  if(!code||isNaN(lat)||isNaN(lng)){ alert('Fill all fields'); return; }
  const marker=L.marker([lat,lng]).addTo(map).bindPopup(`Kiosk: ${code}`);
  kiosks.push({code,lat,lng,marker});
  const sel=document.getElementById('kioskSelect');
  const opt=document.createElement('option'); opt.value=code; opt.text=code; sel.appendChild(opt);
  document.getElementById('kioskCodeInput').value=''; document.getElementById('kioskLat').value=''; document.getElementById('kioskLng').value='';
  closeModal('kioskModal'); alert(`Kiosk ${code} added!`);
}

// Assign agent
function assignAgent(){
  const name=document.getElementById('agentNameInput').value.trim();
  const kioskCode=document.getElementById('kioskSelect').value;
  if(!name||!kioskCode){ alert('Fill all fields'); return; }
  const kiosk=kiosks.find(k=>k.code===kioskCode);
  if(kiosk){ kiosk.marker.bindPopup(`Kiosk: ${kiosk.code}<br>Assigned Agent: ${name}`); alert(`${name} assigned to ${kioskCode}`); document.getElementById('agentNameInput').value=''; closeModal('agentModal'); }
}
</script>

</body>
</html>
